{"version":3,"sources":["../../src/lib/cli_REMOTE_17538.js"],"names":["Bluebird","R","Cli","constructor","options","cwd","cucumberArgs","stdout","argv","runner","pick","eventBroadcaster","getSupportCodeLibrary","supportCodePaths","Object","defineProperty","methods","enumerable","value","getConfiguration","builder","getUnexpandedFeaturePaths","resolve","featurePaths","require","push","stepPaths","config","build","debug","formats","type","score","filter","f","run","configuration","supportCodeLibrary","cleanup","initializeFormatters","formatOptions","testCases","pickleFilter","pickleFilterOptions","runtime","runtimeOptions","once","dryRun","result","success","start","precheck","host","port","runConfig","waitForServerUnavailable","err","ok","message","output","waitForServerAvailable","forceStop","log","stop","gracefullyExit","emit","forceExit"],"mappings":"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","file":"cli_REMOTE_17538.js","sourcesContent":["import {\n  Cli as CucumberCli,\n  supportCodeLibraryBuilder,\n  Runtime,\n  getTestCasesFromFilesystem,\n  PickleFilter,\n} from 'cucumber';\nimport ConfigurationBuilder from 'cucumber/lib/cli/configuration_builder';\nimport * as Bluebird from 'bluebird';\nimport * as R from 'ramda';\nimport { Runner } from './runner';\nimport EventEmitter from 'events';\nimport { fence } from '../lib/format';\n\n\nexport class Cli extends CucumberCli {\n  constructor({ options, cwd, cucumberArgs, stdout  }) {\n    super({\n      cwd, stdout,\n      argv: [ null, '', ...cucumberArgs ],\n    });\n\n    this.options = options;\n    this.runner = new Runner(R.pick([ 'host', 'port', 'command' ], options));\n    this.eventBroadcaster = new EventEmitter();\n  }\n\n  getSupportCodeLibrary(supportCodePaths) {\n    Object.defineProperty(supportCodeLibraryBuilder.methods, 'runner', {\n      enumerable: true,\n      value: this.runner,\n    });\n\n    return super.getSupportCodeLibrary(supportCodePaths);\n  }\n\n  async getConfiguration() {\n    const builder = new ConfigurationBuilder({ argv: this.argv, cwd: this.cwd });\n\n    builder.getUnexpandedFeaturePaths = () => Bluebird.resolve(this.options.featurePaths);\n    builder.options.require.push(...this.options.stepPaths);\n\n    const config = await builder.build();\n\n    if (this.options.debug)\n      config.formats = [ { type: require.resolve('../formatters/debug-formatter') } ];\n\n    if (this.options.score)\n      config.formats.push({ type: require.resolve('../formatters/score-formatter') });\n    else\n      config.formats.push({ type: require.resolve('../formatters/strip-points-formatter') });\n\n    config.formats = config.formats.filter(f => f.type !== 'none');\n\n    return config;\n  }\n\n  async run() {\n    const configuration = await this.getConfiguration();\n    const supportCodeLibrary = this.getSupportCodeLibrary(configuration.supportCodePaths);\n    const cleanup = await this.initializeFormatters({\n      supportCodeLibrary,\n      eventBroadcaster: this.eventBroadcaster,\n      formatOptions: configuration.formatOptions,\n      formats: configuration.formats,\n    });\n\n    const testCases = getTestCasesFromFilesystem({\n      cwd: this.cwd,\n      eventBroadcaster: this.eventBroadcaster,\n      featurePaths: configuration.featurePaths,\n      pickleFilter: new PickleFilter(configuration.pickleFilterOptions),\n    });\n\n    const runtime = new Runtime({\n      eventBroadcaster: this.eventBroadcaster,\n      options: configuration.runtimeOptions,\n      supportCodeLibrary,\n      testCases,\n    });\n\n    this.eventBroadcaster.once('abort', () => {\n      configuration.runtimeOptions.dryRun = true;\n      runtime.result.success = false;\n    });\n\n    try {\n      return await runtime.start();\n    } finally {\n      await cleanup();\n    }\n  }\n\n  async precheck() {\n    const { host, port } = this.runner.runConfig;\n\n    try {\n      await this.runner.waitForServerUnavailable();\n    } catch (err) {\n      return {\n        ok: false,\n        message: `${host}:${port} appears to be in use. Cannot start tests.`,\n      };\n    }\n\n    const output = this.runner.start();\n    try {\n      await this.runner.waitForServerAvailable();\n    } catch (err) {\n      this.runner.forceStop();\n      const log = await output;\n      return {\n        ok: false,\n        message: `Could not connect to ${host}:${port}\n${fence('console log', log)}`,\n      };\n    }\n\n    await this.runner.stop();\n\n    return { ok: true };\n  }\n\n  gracefullyExit() {\n    this.eventBroadcaster.emit('abort');\n    this.runner.stop();\n  }\n\n  forceExit() {\n    this.eventBroadcaster.emit('abort');\n    this.runner.forceStop();\n  }\n}\n\n"]}