'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _attachment_manager = require('./attachment_manager');

var _attachment_manager2 = _interopRequireDefault(_attachment_manager);

var _event = require('./event');

var _event2 = _interopRequireDefault(_event);

var _hook = require('../models/hook');

var _hook2 = _interopRequireDefault(_hook);

var _scenario_result = require('../models/scenario_result');

var _scenario_result2 = _interopRequireDefault(_scenario_result);

var _status = require('../status');

var _status2 = _interopRequireDefault(_status);

var _step_result = require('../models/step_result');

var _step_result2 = _interopRequireDefault(_step_result);

var _step_runner = require('./step_runner');

var _step_runner2 = _interopRequireDefault(_step_runner);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ScenarioRunner = function () {
  function ScenarioRunner(_ref) {
    var _context;

    var eventBroadcaster = _ref.eventBroadcaster,
        options = _ref.options,
        scenario = _ref.scenario,
        supportCodeLibrary = _ref.supportCodeLibrary;
    (0, _classCallCheck3.default)(this, ScenarioRunner);

    this.attachmentManager = new _attachment_manager2.default();
    this.eventBroadcaster = eventBroadcaster;
    this.options = options;
    this.scenario = scenario;
    this.supportCodeLibrary = supportCodeLibrary;
    this.scenarioResult = new _scenario_result2.default(scenario);
    this.world = new supportCodeLibrary.World({
      attach: (_context = this.attachmentManager).create.bind(_context),
      parameters: options.worldParameters
    });
  }

  (0, _createClass3.default)(ScenarioRunner, [{
    key: 'broadcastScenarioResult',
    value: function () {
      var _ref2 = (0, _bluebird.coroutine)(function* () {
        var event = new _event2.default({
          data: this.scenarioResult,
          name: _event2.default.SCENARIO_RESULT_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastEvent(event);
      });

      function broadcastScenarioResult() {
        return _ref2.apply(this, arguments);
      }

      return broadcastScenarioResult;
    }()
  }, {
    key: 'broadcastStepResult',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* (stepResult) {
        this.scenarioResult.witnessStepResult(stepResult);
        var event = new _event2.default({
          data: stepResult,
          name: _event2.default.STEP_RESULT_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastEvent(event);
      });

      function broadcastStepResult(_x) {
        return _ref3.apply(this, arguments);
      }

      return broadcastStepResult;
    }()
  }, {
    key: 'invokeStep',
    value: function invokeStep(step, stepDefinition) {
      return _step_runner2.default.run({
        attachmentManager: this.attachmentManager,
        defaultTimeout: this.supportCodeLibrary.defaultTimeout,
        scenarioResult: this.scenarioResult,
        step: step,
        stepDefinition: stepDefinition,
        parameterTypeRegistry: this.supportCodeLibrary.parameterTypeRegistry,
        world: this.world
      });
    }
  }, {
    key: 'isSkippingSteps',
    value: function isSkippingSteps() {
      return this.scenarioResult.status !== _status2.default.PASSED;
    }
  }, {
    key: 'run',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        var _this = this;

        var event = new _event2.default({
          data: this.scenario,
          name: _event2.default.SCENARIO_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
          yield _this.runBeforeHooks();
          yield _this.runSteps();
          yield _this.runAfterHooks();
          yield _this.broadcastScenarioResult();
        }));
        return this.scenarioResult;
      });

      function run() {
        return _ref4.apply(this, arguments);
      }

      return run;
    }()
  }, {
    key: 'runAfterHooks',
    value: function () {
      var _ref6 = (0, _bluebird.coroutine)(function* () {
        yield this.runHooks({
          hookDefinitions: this.supportCodeLibrary.afterScenarioHookDefinitions,
          hookKeyword: _hook2.default.AFTER_STEP_KEYWORD
        });
      });

      function runAfterHooks() {
        return _ref6.apply(this, arguments);
      }

      return runAfterHooks;
    }()
  }, {
    key: 'runBeforeHooks',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* () {
        yield this.runHooks({
          hookDefinitions: this.supportCodeLibrary.beforeScenarioHookDefinitions,
          hookKeyword: _hook2.default.BEFORE_STEP_KEYWORD
        });
      });

      function runBeforeHooks() {
        return _ref7.apply(this, arguments);
      }

      return runBeforeHooks;
    }()
  }, {
    key: 'runHook',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* (hook, hookDefinition) {
        if (this.options.dryRun) {
          return new _step_result2.default({
            step: hook,
            stepDefinition: hookDefinition,
            status: _status2.default.SKIPPED
          });
        } else {
          return yield this.invokeStep(hook, hookDefinition);
        }
      });

      function runHook(_x2, _x3) {
        return _ref8.apply(this, arguments);
      }

      return runHook;
    }()
  }, {
    key: 'runHooks',
    value: function () {
      var _ref10 = (0, _bluebird.coroutine)(function* (_ref9) {
        var _this2 = this;

        var hookDefinitions = _ref9.hookDefinitions,
            hookKeyword = _ref9.hookKeyword;

        yield _bluebird2.default.each(hookDefinitions, function () {
          var _ref11 = (0, _bluebird.coroutine)(function* (hookDefinition) {
            if (!hookDefinition.appliesToScenario(_this2.scenario)) {
              return;
            }
            var hook = new _hook2.default({ keyword: hookKeyword, scenario: _this2.scenario });
            var event = new _event2.default({ data: hook, name: _event2.default.STEP_EVENT_NAME });
            yield _this2.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
              var stepResult = yield _this2.runHook(hook, hookDefinition);
              yield _this2.broadcastStepResult(stepResult);
            }));
          });

          return function (_x5) {
            return _ref11.apply(this, arguments);
          };
        }());
      });

      function runHooks(_x4) {
        return _ref10.apply(this, arguments);
      }

      return runHooks;
    }()
  }, {
    key: 'runStep',
    value: function () {
      var _ref13 = (0, _bluebird.coroutine)(function* (step) {
        var _this3 = this;

        var stepDefinitions = this.supportCodeLibrary.stepDefinitions.filter(function (stepDefinition) {
          return stepDefinition.matchesStepName({
            stepName: step.name,
            parameterTypeRegistry: _this3.supportCodeLibrary.parameterTypeRegistry
          });
        });
        if (stepDefinitions.length === 0) {
          return new _step_result2.default({
            step: step,
            status: _status2.default.UNDEFINED
          });
        } else if (stepDefinitions.length > 1) {
          return new _step_result2.default({
            ambiguousStepDefinitions: stepDefinitions,
            step: step,
            status: _status2.default.AMBIGUOUS
          });
        } else if (this.options.dryRun || this.isSkippingSteps()) {
          return new _step_result2.default({
            step: step,
            stepDefinition: stepDefinitions[0],
            status: _status2.default.SKIPPED
          });
        } else {
          return yield this.invokeStep(step, stepDefinitions[0]);
        }
      });

      function runStep(_x6) {
        return _ref13.apply(this, arguments);
      }

      return runStep;
    }()
  }, {
    key: 'runSteps',
    value: function () {
      var _ref14 = (0, _bluebird.coroutine)(function* () {
        var _this4 = this;

        yield _bluebird2.default.each(this.scenario.steps, function () {
          var _ref15 = (0, _bluebird.coroutine)(function* (step) {
            var event = new _event2.default({ data: step, name: _event2.default.STEP_EVENT_NAME });
            yield _this4.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
              var stepResult = yield _this4.runStep(step);
              yield _this4.broadcastStepResult(stepResult);
            }));
          });

          return function (_x7) {
            return _ref15.apply(this, arguments);
          };
        }());
      });

      function runSteps() {
        return _ref14.apply(this, arguments);
      }

      return runSteps;
    }()
  }]);
  return ScenarioRunner;
}();

exports.default = ScenarioRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL3NjZW5hcmlvX3J1bm5lci5qcyJdLCJuYW1lcyI6WyJTY2VuYXJpb1J1bm5lciIsImV2ZW50QnJvYWRjYXN0ZXIiLCJvcHRpb25zIiwic2NlbmFyaW8iLCJzdXBwb3J0Q29kZUxpYnJhcnkiLCJhdHRhY2htZW50TWFuYWdlciIsInNjZW5hcmlvUmVzdWx0Iiwid29ybGQiLCJXb3JsZCIsImF0dGFjaCIsImNyZWF0ZSIsInBhcmFtZXRlcnMiLCJ3b3JsZFBhcmFtZXRlcnMiLCJldmVudCIsImRhdGEiLCJuYW1lIiwiU0NFTkFSSU9fUkVTVUxUX0VWRU5UX05BTUUiLCJicm9hZGNhc3RFdmVudCIsInN0ZXBSZXN1bHQiLCJ3aXRuZXNzU3RlcFJlc3VsdCIsIlNURVBfUkVTVUxUX0VWRU5UX05BTUUiLCJzdGVwIiwic3RlcERlZmluaXRpb24iLCJydW4iLCJkZWZhdWx0VGltZW91dCIsInBhcmFtZXRlclR5cGVSZWdpc3RyeSIsInN0YXR1cyIsIlBBU1NFRCIsIlNDRU5BUklPX0VWRU5UX05BTUUiLCJicm9hZGNhc3RBcm91bmRFdmVudCIsInJ1bkJlZm9yZUhvb2tzIiwicnVuU3RlcHMiLCJydW5BZnRlckhvb2tzIiwiYnJvYWRjYXN0U2NlbmFyaW9SZXN1bHQiLCJydW5Ib29rcyIsImhvb2tEZWZpbml0aW9ucyIsImFmdGVyU2NlbmFyaW9Ib29rRGVmaW5pdGlvbnMiLCJob29rS2V5d29yZCIsIkFGVEVSX1NURVBfS0VZV09SRCIsImJlZm9yZVNjZW5hcmlvSG9va0RlZmluaXRpb25zIiwiQkVGT1JFX1NURVBfS0VZV09SRCIsImhvb2siLCJob29rRGVmaW5pdGlvbiIsImRyeVJ1biIsIlNLSVBQRUQiLCJpbnZva2VTdGVwIiwiZWFjaCIsImFwcGxpZXNUb1NjZW5hcmlvIiwia2V5d29yZCIsIlNURVBfRVZFTlRfTkFNRSIsInJ1bkhvb2siLCJicm9hZGNhc3RTdGVwUmVzdWx0Iiwic3RlcERlZmluaXRpb25zIiwiZmlsdGVyIiwibWF0Y2hlc1N0ZXBOYW1lIiwic3RlcE5hbWUiLCJsZW5ndGgiLCJVTkRFRklORUQiLCJhbWJpZ3VvdXNTdGVwRGVmaW5pdGlvbnMiLCJBTUJJR1VPVVMiLCJpc1NraXBwaW5nU3RlcHMiLCJzdGVwcyIsInJ1blN0ZXAiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7SUFFcUJBLGM7QUFDbkIsZ0NBQXlFO0FBQUE7O0FBQUEsUUFBM0RDLGdCQUEyRCxRQUEzREEsZ0JBQTJEO0FBQUEsUUFBekNDLE9BQXlDLFFBQXpDQSxPQUF5QztBQUFBLFFBQWhDQyxRQUFnQyxRQUFoQ0EsUUFBZ0M7QUFBQSxRQUF0QkMsa0JBQXNCLFFBQXRCQSxrQkFBc0I7QUFBQTs7QUFDdkUsU0FBS0MsaUJBQUwsR0FBeUIsa0NBQXpCO0FBQ0EsU0FBS0osZ0JBQUwsR0FBd0JBLGdCQUF4QjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0Msa0JBQUwsR0FBMEJBLGtCQUExQjtBQUNBLFNBQUtFLGNBQUwsR0FBc0IsOEJBQW1CSCxRQUFuQixDQUF0QjtBQUNBLFNBQUtJLEtBQUwsR0FBYSxJQUFJSCxtQkFBbUJJLEtBQXZCLENBQTZCO0FBQ3hDQyxjQUFVLGlCQUFLSixpQkFBTCxFQUF1QkssTUFBakMsZUFEd0M7QUFFeENDLGtCQUFZVCxRQUFRVTtBQUZvQixLQUE3QixDQUFiO0FBSUQ7Ozs7O3dEQUUrQjtBQUM5QixZQUFNQyxRQUFRLG9CQUFVO0FBQ3RCQyxnQkFBTSxLQUFLUixjQURXO0FBRXRCUyxnQkFBTSxnQkFBTUM7QUFGVSxTQUFWLENBQWQ7QUFJQSxjQUFNLEtBQUtmLGdCQUFMLENBQXNCZ0IsY0FBdEIsQ0FBcUNKLEtBQXJDLENBQU47QUFDRCxPOzs7Ozs7Ozs7OztzREFFeUJLLFUsRUFBWTtBQUNwQyxhQUFLWixjQUFMLENB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RWdCO0FBQUE7O0FBQ2YsY0FBTSxtQkFBUU4sSUFBUixDQUFhLEtBQUszQyxRQUFMLENBQWMwRCxLQUEzQjtBQUFBLGdEQUFrQyxXQUFNeEMsSUFBTixFQUFjO0FBQ3BELGdCQUFNUixRQUFRLG9CQUFVLEVBQUVDLE1BQU1PLElBQVIsRUFBY04sTUFBTSxnQkFBTWtDLGVBQTFCLEVBQVYsQ0FBZDtBQUNBLGtCQUFNLE9BQUtoRCxnQkFBTCxDQUFzQjRCLG9CQUF0QixDQUEyQ2hCLEtBQTNDLDJCQUFrRCxhQUFZO0FBQ2xFLGtCQUFNSyxhQUFhLE1BQU0sT0FBSzRDLE9BQUwsQ0FBYXpDLElBQWIsQ0FBekI7QUFDQSxvQkFBTSxPQUFLOEIsbUJBQUwsQ0FBeUJqQyxVQUF6QixDQUFOO0FBQ0QsYUFISyxFQUFOO0FBSUQsV0FOSzs7QUFBQTtBQUFBO0FBQUE7QUFBQSxZQUFOO0FBT0QsTzs7Ozs7Ozs7Ozs7O2tCQTVJa0JsQixjIiwiZmlsZSI6InNjZW5hcmlvX3J1bm5lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBdHRhY2htZW50TWFuYWdlciBmcm9tICcuL2F0dGFjaG1lbnRfbWFuYWdlcidcbmltcG9ydCBFdmVudCBmcm9tICcuL2V2ZW50J1xuaW1wb3J0IEhvb2sgZnJvbSAnLi4vbW9kZWxzL2hvb2snXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBTY2VuYXJpb1Jlc3VsdCBmcm9tICcuLi9tb2RlbHMvc2NlbmFyaW9fcmVzdWx0J1xuaW1wb3J0IFN0YXR1cyBmcm9tICcuLi9zdGF0dXMnXG5pbXBvcnQgU3RlcFJlc3VsdCBmcm9tICcuLi9tb2RlbHMvc3RlcF9yZXN1bHQnXG5pbXBvcnQgU3RlcFJ1bm5lciBmcm9tICcuL3N0ZXBfcnVubmVyJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY2VuYXJpb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yKHsgZXZlbnRCcm9hZGNhc3Rlciwgb3B0aW9ucywgc2NlbmFyaW8sIHN1cHBvcnRDb2RlTGlicmFyeSB9KSB7XG4gICAgdGhpcy5hdHRhY2htZW50TWFuYWdlciA9IG5ldyBBdHRhY2htZW50TWFuYWdlcigpXG4gICAgdGhpcy5ldmVudEJyb2FkY2FzdGVyID0gZXZlbnRCcm9hZGNhc3RlclxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnNcbiAgICB0aGlzLnNjZW5hcmlvID0gc2NlbmFyaW9cbiAgICB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeSA9IHN1cHBvcnRDb2RlTGlicmFyeVxuICAgIHRoaXMuc2NlbmFyaW9SZXN1bHQgPSBuZXcgU2NlbmFyaW9SZXN1bHQoc2NlbmFyaW8pXG4gICAgdGhpcy53b3JsZCA9IG5ldyBzdXBwb3J0Q29kZUxpYnJhcnkuV29ybGQoe1xuICAgICAgYXR0YWNoOiA6OnRoaXMuYXR0YWNobWVudE1hbmFnZXIuY3JlYXRlLFxuICAgICAgcGFyYW1ldGVyczogb3B0aW9ucy53b3JsZFBhcmFtZXRlcnNcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgYnJvYWRjYXN0U2NlbmFyaW9SZXN1bHQoKSB7XG4gICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoe1xuICAgICAgZGF0YTogdGhpcy5zY2VuYXJpb1Jlc3VsdCxcbiAgICAgIG5hbWU6IEV2ZW50LlNDRU5BUklPX1JFU1VMVF9FVkVOVF9OQU1FXG4gICAgfSlcbiAgICBhd2FpdCB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIuYnJvYWRjYXN0RXZlbnQoZXZlbnQpXG4gIH1cblxuICBhc3luYyBicm9hZGNhc3RTdGVwUmVzdWx0KHN0ZXBSZXN1bHQpIHtcbiAgICB0aGlzLnNjZW5hcmlvUmVzdWx0LndpdG5lc3NTdGVwUmVzdWx0KHN0ZXBSZXN1bHQpXG4gICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoe1xuICAgICAgZGF0YTogc3RlcFJlc3VsdCxcbiAgICAgIG5hbWU6IEV2ZW50LlNURVBfUkVTVUxUX0VWRU5UX05BTUVcbiAgICB9KVxuICAgIGF3YWl0IHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3RFdmVudChldmVudClcbiAgfVxuXG4gIGludm9rZVN0ZXAoc3RlcCwgc3RlcERlZmluaXRpb24pIHtcbiAgICByZXR1cm4gU3RlcFJ1bm5lci5ydW4oe1xuICAgICAgYXR0YWNobWVudE1hbmFnZXI6IHRoaXMuYXR0YWNobWVudE1hbmFnZXIsXG4gICAgICBkZWZhdWx0VGltZW91dDogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuZGVmYXVsdFRpbWVvdXQsXG4gICAgICBzY2VuYXJpb1Jlc3VsdDogdGhpcy5zY2VuYXJpb1Jlc3VsdCxcbiAgICAgIHN0ZXAsXG4gICAgICBzdGVwRGVmaW5pdGlvbixcbiAgICAgIHBhcmFtZXRlclR5cGVSZWdpc3RyeTogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkucGFyYW1ldGVyVHlwZVJlZ2lzdHJ5LFxuICAgICAgd29ybGQ6IHRoaXMud29ybGRcbiAgICB9KVxuICB9XG5cbiAgaXNTa2lwcGluZ1N0ZXBzKCkge1xuICAgIHJldHVybiB0aGlzLnNjZW5hcmlvUmVzdWx0LnN0YXR1cyAhPT0gU3RhdHVzLlBBU1NFRFxuICB9XG5cbiAgYXN5bmMgcnVuKCkge1xuICAgIGNvbnN0IGV2ZW50ID0gbmV3IEV2ZW50KHtcbiAgICAgIGRhdGE6IHRoaXMuc2NlbmFyaW8sXG4gICAgICBuYW1lOiBFdmVudC5TQ0VOQVJJT19FVkVOVF9OQU1FXG4gICAgfSlcbiAgICBhd2FpdCB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIuYnJvYWRjYXN0QXJvdW5kRXZlbnQoZXZlbnQsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucnVuQmVmb3JlSG9va3MoKVxuICAgICAgYXdhaXQgdGhpcy5ydW5TdGVwcygpXG4gICAgICBhd2FpdCB0aGlzLnJ1bkFmdGVySG9va3MoKVxuICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RTY2VuYXJpb1Jlc3VsdCgpXG4gICAgfSlcbiAgICByZXR1cm4gdGhpcy5zY2VuYXJpb1Jlc3VsdFxuICB9XG5cbiAgYXN5bmMgcnVuQWZ0ZXJIb29rcygpIHtcbiAgICBhd2FpdCB0aGlzLnJ1bkhvb2tzKHtcbiAgICAgIGhvb2tEZWZpbml0aW9uczogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuYWZ0ZXJTY2VuYXJpb0hvb2tEZWZpbml0aW9ucyxcbiAgICAgIGhvb2tLZXl3b3JkOiBIb29rLkFGVEVSX1NURVBfS0VZV09SRFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBydW5CZWZvcmVIb29rcygpIHtcbiAgICBhd2FpdCB0aGlzLnJ1bkhvb2tzKHtcbiAgICAgIGhvb2tEZWZpbml0aW9uczogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuYmVmb3JlU2NlbmFyaW9Ib29rRGVmaW5pdGlvbnMsXG4gICAgICBob29rS2V5d29yZDogSG9vay5CRUZPUkVfU1RFUF9LRVlXT1JEXG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIHJ1bkhvb2soaG9vaywgaG9va0RlZmluaXRpb24pIHtcbiAgICBpZiAodGhpcy5vcHRpb25zLmRyeVJ1bikge1xuICAgICAgcmV0dXJuIG5ldyBTdGVwUmVzdWx0KHtcbiAgICAgICAgc3RlcDogaG9vayxcbiAgICAgICAgc3RlcERlZmluaXRpb246IGhvb2tEZWZpbml0aW9uLFxuICAgICAgICBzdGF0dXM6IFN0YXR1cy5TS0lQUEVEXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnZva2VTdGVwKGhvb2ssIGhvb2tEZWZpbml0aW9uKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJ1bkhvb2tzKHsgaG9va0RlZmluaXRpb25zLCBob29rS2V5d29yZCB9KSB7XG4gICAgYXdhaXQgUHJvbWlzZS5lYWNoKGhvb2tEZWZpbml0aW9ucywgYXN5bmMgaG9va0RlZmluaXRpb24gPT4ge1xuICAgICAgaWYgKCFob29rRGVmaW5pdGlvbi5hcHBsaWVzVG9TY2VuYXJpbyh0aGlzLnNjZW5hcmlvKSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IGhvb2sgPSBuZXcgSG9vayh7IGtleXdvcmQ6IGhvb2tLZXl3b3JkLCBzY2VuYXJpbzogdGhpcy5zY2VuYXJpbyB9KVxuICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoeyBkYXRhOiBob29rLCBuYW1lOiBFdmVudC5TVEVQX0VWRU5UX05BTUUgfSlcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3RBcm91bmRFdmVudChldmVudCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBzdGVwUmVzdWx0ID0gYXdhaXQgdGhpcy5ydW5Ib29rKGhvb2ssIGhvb2tEZWZpbml0aW9uKVxuICAgICAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFN0ZXBSZXN1bHQoc3RlcFJlc3VsdClcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIHJ1blN0ZXAoc3RlcCkge1xuICAgIGNvbnN0IHN0ZXBEZWZpbml0aW9ucyA9IHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5LnN0ZXBEZWZpbml0aW9ucy5maWx0ZXIoXG4gICAgICBzdGVwRGVmaW5pdGlvbiA9PiB7XG4gICAgICAgIHJldHVybiBzdGVwRGVmaW5pdGlvbi5tYXRjaGVzU3RlcE5hbWUoe1xuICAgICAgICAgIHN0ZXBOYW1lOiBzdGVwLm5hbWUsXG4gICAgICAgICAgcGFyYW1ldGVyVHlwZVJlZ2lzdHJ5OiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5wYXJhbWV0ZXJUeXBlUmVnaXN0cnlcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICApXG4gICAgaWYgKHN0ZXBEZWZpbml0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBuZXcgU3RlcFJlc3VsdCh7XG4gICAgICAgIHN0ZXAsXG4gICAgICAgIHN0YXR1czogU3RhdHVzLlVOREVGSU5FRFxuICAgICAgfSlcbiAgICB9IGVsc2UgaWYgKHN0ZXBEZWZpbml0aW9ucy5sZW5ndGggPiAxKSB7XG4gICAgICByZXR1cm4gbmV3IFN0ZXBSZXN1bHQoe1xuICAgICAgICBhbWJpZ3VvdXNTdGVwRGVmaW5pdGlvbnM6IHN0ZXBEZWZpbml0aW9ucyxcbiAgICAgICAgc3RlcCxcbiAgICAgICAgc3RhdHVzOiBTdGF0dXMuQU1CSUdVT1VTXG4gICAgICB9KVxuICAgIH0gZWxzZSBpZiAodGhpcy5vcHRpb25zLmRyeVJ1biB8fCB0aGlzLmlzU2tpcHBpbmdTdGVwcygpKSB7XG4gICAgICByZXR1cm4gbmV3IFN0ZXBSZXN1bHQoe1xuICAgICAgICBzdGVwLFxuICAgICAgICBzdGVwRGVmaW5pdGlvbjogc3RlcERlZmluaXRpb25zWzBdLFxuICAgICAgICBzdGF0dXM6IFN0YXR1cy5TS0lQUEVEXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnZva2VTdGVwKHN0ZXAsIHN0ZXBEZWZpbml0aW9uc1swXSlcbiAgICB9XG4gIH1cblxuICBhc3luYyBydW5TdGVwcygpIHtcbiAgICBhd2FpdCBQcm9taXNlLmVhY2godGhpcy5zY2VuYXJpby5zdGVwcywgYXN5bmMgc3RlcCA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudCh7IGRhdGE6IHN0ZXAsIG5hbWU6IEV2ZW50LlNURVBfRVZFTlRfTkFNRSB9KVxuICAgICAgYXdhaXQgdGhpcy5ldmVudEJyb2FkY2FzdGVyLmJyb2FkY2FzdEFyb3VuZEV2ZW50KGV2ZW50LCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0ZXBSZXN1bHQgPSBhd2FpdCB0aGlzLnJ1blN0ZXAoc3RlcClcbiAgICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RTdGVwUmVzdWx0KHN0ZXBSZXN1bHQpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn1cbiJdfQ==