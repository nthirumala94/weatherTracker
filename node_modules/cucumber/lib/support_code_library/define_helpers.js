'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

exports.defineScenarioHook = defineScenarioHook;
exports.defineFeaturesHook = defineFeaturesHook;
exports.defineStep = defineStep;
exports.registerHandler = registerHandler;
exports.addTransform = addTransform;
exports.defineParameterType = defineParameterType;

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _cucumberExpressions = require('cucumber-expressions');

var _helpers = require('../formatter/helpers');

var _scenario_hook_definition = require('../models/scenario_hook_definition');

var _scenario_hook_definition2 = _interopRequireDefault(_scenario_hook_definition);

var _features_hook_definition = require('../models/features_hook_definition');

var _features_hook_definition2 = _interopRequireDefault(_features_hook_definition);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _stacktraceJs = require('stacktrace-js');

var _stacktraceJs2 = _interopRequireDefault(_stacktraceJs);

var _step_definition = require('../models/step_definition');

var _step_definition2 = _interopRequireDefault(_step_definition);

var _validate_arguments = require('./validate_arguments');

var _validate_arguments2 = _interopRequireDefault(_validate_arguments);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function defineScenarioHook(library, collectionName) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd = getDefinitionLineAndUri(library.cwd),
        line = _getDefinitionLineAnd.line,
        uri = _getDefinitionLineAnd.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineScenarioHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _scenario_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    library.options[collectionName].push(hookDefinition);
  };
}

function defineFeaturesHook(library, collectionName) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd2 = getDefinitionLineAndUri(library.cwd),
        line = _getDefinitionLineAnd2.line,
        uri = _getDefinitionLineAnd2.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineFeaturesHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _features_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    library.options[collectionName].push(hookDefinition);
  };
}

function defineStep(library) {
  return function (pattern, options, code) {
    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd3 = getDefinitionLineAndUri(library.cwd),
        line = _getDefinitionLineAnd3.line,
        uri = _getDefinitionLineAnd3.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, pattern: pattern, options: options },
      fnName: 'defineStep',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var stepDefinition = new _step_definition2.default({
      code: code,
      line: line,
      options: options,
      pattern: pattern,
      uri: uri
    });
    library.options.stepDefinitions.push(stepDefinition);
  };
}

function getDefinitionLineAndUri(cwd) {
  var stackframes = _stacktraceJs2.default.getSync();
  var stackframe = _lodash2.default.find(stackframes, function (frame, index) {
    var filename = frame.getFileName();
    var result = !_lodash2.default.includes(filename, _path2.default.join(__dirname, '..', '..', 'src')) && !_lodash2.default.includes(filename, _path2.default.join(__dirname, '..', '..', 'lib'));
    console.log('checking index', index, 'with filename', frame.getFileName(), 'when made relative', 'has result', result);
    return result;
  });
  var line = stackframe.getLineNumber();
  var uri = stackframe.getFileName();
  if (uri) {
    uri = _path2.default.relative(cwd, uri.replace(/\//g, _path2.default.sep));
  } else {
    uri = 'unknown';
  }
  return { line: line, uri: uri };
}

function registerHandler(library) {
  return function (eventName, options, code) {
    var _$assign;

    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd4 = getDefinitionLineAndUri(library.cwd),
        line = _getDefinitionLineAnd4.line,
        uri = _getDefinitionLineAnd4.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, eventName: eventName, options: options },
      fnName: 'registerHandler',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var listener = _lodash2.default.assign((_$assign = {}, (0, _defineProperty3.default)(_$assign, 'handle' + eventName, code), (0, _defineProperty3.default)(_$assign, 'location', (0, _helpers.formatLocation)({ line: line, uri: uri })), _$assign), options);
    library.options.listeners.push(listener);
  };
}

function addTransform(library) {
  return _util2.default.deprecate(function (_ref) {
    var captureGroupRegexps = _ref.captureGroupRegexps,
        transformer = _ref.transformer,
        typeName = _ref.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, captureGroupRegexps, transformer);
    library.options.parameterTypeRegistry.defineParameterType(parameter);
  }, 'addTransform is deprecated and will be removed in a future version. Please use defineParameterType instead.');
}

function defineParameterType(library) {
  return function (_ref2) {
    var regexp = _ref2.regexp,
        transformer = _ref2.transformer,
        typeName = _ref2.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, regexp, transformer);
    library.options.parameterTypeRegistry.defineParameterType(parameter);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdXBwb3J0X2NvZGVfbGlicmFyeS9kZWZpbmVfaGVscGVycy5qcyJdLCJuYW1lcyI6WyJkZWZpbmVTY2VuYXJpb0hvb2siLCJkZWZpbmVGZWF0dXJlc0hvb2siLCJkZWZpbmVTdGVwIiwicmVnaXN0ZXJIYW5kbGVyIiwiYWRkVHJhbnNmb3JtIiwiZGVmaW5lUGFyYW1ldGVyVHlwZSIsImxpYnJhcnkiLCJjb2xsZWN0aW9uTmFtZSIsIm9wdGlvbnMiLCJjb2RlIiwidGFncyIsImdldERlZmluaXRpb25MaW5lQW5kVXJpIiwiY3dkIiwibGluZSIsInVyaSIsImFyZ3MiLCJmbk5hbWUiLCJsb2NhdGlvbiIsImhvb2tEZWZpbml0aW9uIiwicHVzaCIsInBhdHRlcm4iLCJzdGVwRGVmaW5pdGlvbiIsInN0ZXBEZWZpbml0aW9ucyIsInN0YWNrZnJhbWVzIiwiZ2V0U3luYyIsInN0YWNrZnJhbWUiLCJmaW5kIiwiZnJhbWUiLCJpbmRleCIsImZpbGVuYW1lIiwiZ2V0RmlsZU5hbWUiLCJyZXN1bHQiLCJpbmNsdWRlcyIsImpvaW4iLCJfX2Rpcm5hbWUiLCJjb25zb2xlIiwibG9nIiwiZ2V0TGluZU51bWJlciIsInJlbGF0aXZlIiwicmVwbGFjZSIsInNlcCIsImV2ZW50TmFtZSIsImxpc3RlbmVyIiwiYXNzaWduIiwibGlzdGVuZXJzIiwiZGVwcmVjYXRlIiwiY2FwdHVyZUdyb3VwUmVnZXhwcyIsInRyYW5zZm9ybWVyIiwidHlwZU5hbWUiLCJwYXJhbWV0ZXIiLCJwYXJhbWV0ZXJUeXBlUmVnaXN0cnkiLCJyZWdleHAiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7UUFXZ0JBLGtCLEdBQUFBLGtCO1FBd0JBQyxrQixHQUFBQSxrQjtRQXdCQUMsVSxHQUFBQSxVO1FBbURBQyxlLEdBQUFBLGU7UUF1QkFDLFksR0FBQUEsWTtRQVlBQyxtQixHQUFBQSxtQjs7QUFqSmhCOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7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cUJBQWhCLENBQXNDN0MsbUJBQXRDLENBQTBENEMsU0FBMUQ7QUFDRCxHQVJNLEVBUUosNkdBUkksQ0FBUDtBQVNEOztBQUVNLFNBQVM1QyxtQkFBVCxDQUE2QkMsT0FBN0IsRUFBc0M7QUFDM0MsU0FBTyxpQkFBdUM7QUFBQSxRQUFwQzZDLE1BQW9DLFNBQXBDQSxNQUFvQztBQUFBLFFBQTVCSixXQUE0QixTQUE1QkEsV0FBNEI7QUFBQSxRQUFmQyxRQUFlLFNBQWZBLFFBQWU7O0FBQzVDLFFBQU1DLFlBQVksdUNBQWtCRCxRQUFsQixFQUE0QixJQUE1QixFQUFrQ0csTUFBbEMsRUFBMENKLFdBQTFDLENBQWxCO0FBQ0F6QyxZQUFRRSxPQUFSLENBQWdCMEMscUJBQWhCLENBQXNDN0MsbUJBQXRDLENBQTBENEMsU0FBMUQ7QUFDRCxHQUhEO0FBSUQiLCJmaWxlIjoiZGVmaW5lX2hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCBmcm9tICd1dGlsJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IHsgUGFyYW1ldGVyVHlwZSB9IGZyb20gJ2N1Y3VtYmVyLWV4cHJlc3Npb25zJ1xuaW1wb3J0IHsgZm9ybWF0TG9jYXRpb24gfSBmcm9tICcuLi9mb3JtYXR0ZXIvaGVscGVycydcbmltcG9ydCBTY2VuYXJpb0hvb2tEZWZpbml0aW9uIGZyb20gJy4uL21vZGVscy9zY2VuYXJpb19ob29rX2RlZmluaXRpb24nXG5pbXBvcnQgRmVhdHVyZXNIb29rRGVmaW5pdGlvbiBmcm9tICcuLi9tb2RlbHMvZmVhdHVyZXNfaG9va19kZWZpbml0aW9uJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBTdGFja1RyYWNlIGZyb20gJ3N0YWNrdHJhY2UtanMnXG5pbXBvcnQgU3RlcERlZmluaXRpb24gZnJvbSAnLi4vbW9kZWxzL3N0ZXBfZGVmaW5pdGlvbidcbmltcG9ydCB2YWxpZGF0ZUFyZ3VtZW50cyBmcm9tICcuL3ZhbGlkYXRlX2FyZ3VtZW50cydcblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVNjZW5hcmlvSG9vayhsaWJyYXJ5LCBjb2xsZWN0aW9uTmFtZSkge1xuICByZXR1cm4gKG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zID0geyB0YWdzOiBvcHRpb25zIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb2RlID0gb3B0aW9uc1xuICAgICAgb3B0aW9ucyA9IHt9XG4gICAgfVxuICAgIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShsaWJyYXJ5LmN3ZClcbiAgICB2YWxpZGF0ZUFyZ3VtZW50cyh7XG4gICAgICBhcmdzOiB7IGNvZGUsIG9wdGlvbnMgfSxcbiAgICAgIGZuTmFtZTogJ2RlZmluZVNjZW5hcmlvSG9vaycsXG4gICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICB9KVxuICAgIGNvbnN0IGhvb2tEZWZpbml0aW9uID0gbmV3IFNjZW5hcmlvSG9va0RlZmluaXRpb24oe1xuICAgICAgY29kZSxcbiAgICAgIGxpbmUsXG4gICAgICBvcHRpb25zLFxuICAgICAgdXJpXG4gICAgfSlcbiAgICBsaWJyYXJ5Lm9wdGlvbnNbY29sbGVjdGlvbk5hbWVdLnB1c2goaG9va0RlZmluaXRpb24pXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZlYXR1cmVzSG9vayhsaWJyYXJ5LCBjb2xsZWN0aW9uTmFtZSkge1xuICByZXR1cm4gKG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zID0geyB0YWdzOiBvcHRpb25zIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb2RlID0gb3B0aW9uc1xuICAgICAgb3B0aW9ucyA9IHt9XG4gICAgfVxuICAgIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShsaWJyYXJ5LmN3ZClcbiAgICB2YWxpZGF0ZUFyZ3VtZW50cyh7XG4gICAgICBhcmdzOiB7IGNvZGUsIG9wdGlvbnMgfSxcbiAgICAgIGZuTmFtZTogJ2RlZmluZUZlYXR1cmVzSG9vaycsXG4gICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICB9KVxuICAgIGNvbnN0IGhvb2tEZWZpbml0aW9uID0gbmV3IEZlYXR1cmVzSG9va0RlZmluaXRpb24oe1xuICAgICAgY29kZSxcbiAgICAgIGxpbmUsXG4gICAgICBvcHRpb25zLFxuICAgICAgdXJpXG4gICAgfSlcbiAgICBsaWJyYXJ5Lm9wdGlvbnNbY29sbGVjdGlvbk5hbWVdLnB1c2goaG9va0RlZmluaXRpb24pXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVN0ZXAobGlicmFyeSkge1xuICByZXR1cm4gKHBhdHRlcm4sIG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvZGUgPSBvcHRpb25zXG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG4gICAgY29uc3QgeyBsaW5lLCB1cmkgfSA9IGdldERlZmluaXRpb25MaW5lQW5kVXJpKGxpYnJhcnkuY3dkKVxuICAgIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICAgIGFyZ3M6IHsgY29kZSwgcGF0dGVybiwgb3B0aW9ucyB9LFxuICAgICAgZm5OYW1lOiAnZGVmaW5lU3RlcCcsXG4gICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICB9KVxuICAgIGNvbnN0IHN0ZXBEZWZpbml0aW9uID0gbmV3IFN0ZXBEZWZpbml0aW9uKHtcbiAgICAgIGNvZGUsXG4gICAgICBsaW5lLFxuICAgICAgb3B0aW9ucyxcbiAgICAgIHBhdHRlcm4sXG4gICAgICB1cmlcbiAgICB9KVxuICAgIGxpYnJhcnkub3B0aW9ucy5zdGVwRGVmaW5pdGlvbnMucHVzaChzdGVwRGVmaW5pdGlvbilcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpIHtcbiAgY29uc3Qgc3RhY2tmcmFtZXMgPSBTdGFja1RyYWNlLmdldFN5bmMoKVxuICBjb25zdCBzdGFja2ZyYW1lID0gXy5maW5kKHN0YWNrZnJhbWVzLCAoZnJhbWUsIGluZGV4KSA9PiB7XG4gICAgY29uc3QgZmlsZW5hbWUgPSBmcmFtZS5nZXRGaWxlTmFtZSgpXG4gICAgY29uc3QgcmVzdWx0ID1cbiAgICAgICFfLmluY2x1ZGVzKGZpbGVuYW1lLCBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnc3JjJykpICYmXG4gICAgICAhXy5pbmNsdWRlcyhmaWxlbmFtZSwgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2xpYicpKVxuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJ2NoZWNraW5nIGluZGV4JyxcbiAgICAgIGluZGV4LFxuICAgICAgJ3dpdGggZmlsZW5hbWUnLFxuICAgICAgZnJhbWUuZ2V0RmlsZU5hbWUoKSxcbiAgICAgICd3aGVuIG1hZGUgcmVsYXRpdmUnLFxuICAgICAgJ2hhcyByZXN1bHQnLFxuICAgICAgcmVzdWx0XG4gICAgKVxuICAgIHJldHVybiByZXN1bHRcbiAgfSlcbiAgY29uc3QgbGluZSA9IHN0YWNrZnJhbWUuZ2V0TGluZU51bWJlcigpXG4gIGxldCB1cmkgPSBzdGFja2ZyYW1lLmdldEZpbGVOYW1lKClcbiAgaWYgKHVyaSkge1xuICAgIHVyaSA9IHBhdGgucmVsYXRpdmUoY3dkLCB1cmkucmVwbGFjZSgvXFwvL2csIHBhdGguc2VwKSlcbiAgfSBlbHNlIHtcbiAgICB1cmkgPSAndW5rbm93bidcbiAgfVxuICByZXR1cm4geyBsaW5lLCB1cmkgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJIYW5kbGVyKGxpYnJhcnkpIHtcbiAgcmV0dXJuIChldmVudE5hbWUsIG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvZGUgPSBvcHRpb25zXG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG4gICAgY29uc3QgeyBsaW5lLCB1cmkgfSA9IGdldERlZmluaXRpb25MaW5lQW5kVXJpKGxpYnJhcnkuY3dkKVxuICAgIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICAgIGFyZ3M6IHsgY29kZSwgZXZlbnROYW1lLCBvcHRpb25zIH0sXG4gICAgICBmbk5hbWU6ICdyZWdpc3RlckhhbmRsZXInLFxuICAgICAgbG9jYXRpb246IGZvcm1hdExvY2F0aW9uKHsgbGluZSwgdXJpIH0pXG4gICAgfSlcbiAgICBjb25zdCBsaXN0ZW5lciA9IF8uYXNzaWduKFxuICAgICAge1xuICAgICAgICBbYGhhbmRsZSR7ZXZlbnROYW1lfWBdOiBjb2RlLFxuICAgICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICAgIH0sXG4gICAgICBvcHRpb25zXG4gICAgKVxuICAgIGxpYnJhcnkub3B0aW9ucy5saXN0ZW5lcnMucHVzaChsaXN0ZW5lcilcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkVHJhbnNmb3JtKGxpYnJhcnkpIHtcbiAgcmV0dXJuIHV0aWwuZGVwcmVjYXRlKCh7IGNhcHR1cmVHcm91cFJlZ2V4cHMsIHRyYW5zZm9ybWVyLCB0eXBlTmFtZSB9KSA9PiB7XG4gICAgY29uc3QgcGFyYW1ldGVyID0gbmV3IFBhcmFtZXRlclR5cGUoXG4gICAgICB0eXBlTmFtZSxcbiAgICAgIG51bGwsXG4gICAgICBjYXB0dXJlR3JvdXBSZWdleHBzLFxuICAgICAgdHJhbnNmb3JtZXJcbiAgICApXG4gICAgbGlicmFyeS5vcHRpb25zLnBhcmFtZXRlclR5cGVSZWdpc3RyeS5kZWZpbmVQYXJhbWV0ZXJUeXBlKHBhcmFtZXRlcilcbiAgfSwgJ2FkZFRyYW5zZm9ybSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlIHVzZSBkZWZpbmVQYXJhbWV0ZXJUeXBlIGluc3RlYWQuJylcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVBhcmFtZXRlclR5cGUobGlicmFyeSkge1xuICByZXR1cm4gKHsgcmVnZXhwLCB0cmFuc2Zvcm1lciwgdHlwZU5hbWUgfSkgPT4ge1xuICAgIGNvbnN0IHBhcmFtZXRlciA9IG5ldyBQYXJhbWV0ZXJUeXBlKHR5cGVOYW1lLCBudWxsLCByZWdleHAsIHRyYW5zZm9ybWVyKVxuICAgIGxpYnJhcnkub3B0aW9ucy5wYXJhbWV0ZXJUeXBlUmVnaXN0cnkuZGVmaW5lUGFyYW1ldGVyVHlwZShwYXJhbWV0ZXIpXG4gIH1cbn1cbiJdfQ==