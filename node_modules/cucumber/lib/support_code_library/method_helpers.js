'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

exports.defineScenarioHook = defineScenarioHook;
exports.defineFeaturesHook = defineFeaturesHook;
exports.defineStep = defineStep;
exports.registerHandler = registerHandler;
exports.addTransform = addTransform;
exports.defineParameterType = defineParameterType;

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _cucumberExpressions = require('cucumber-expressions');

var _helpers = require('../formatter/helpers');

var _scenario_hook_definition = require('../models/scenario_hook_definition');

var _scenario_hook_definition2 = _interopRequireDefault(_scenario_hook_definition);

var _features_hook_definition = require('../models/features_hook_definition');

var _features_hook_definition2 = _interopRequireDefault(_features_hook_definition);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _stacktraceJs = require('stacktrace-js');

var _stacktraceJs2 = _interopRequireDefault(_stacktraceJs);

var _step_definition = require('../models/step_definition');

var _step_definition2 = _interopRequireDefault(_step_definition);

var _validate_arguments = require('./validate_arguments');

var _validate_arguments2 = _interopRequireDefault(_validate_arguments);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function defineScenarioHook(cwd, collection) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd.line,
        uri = _getDefinitionLineAnd.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineScenarioHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _scenario_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    collection.push(hookDefinition);
  };
}

function defineFeaturesHook(cwd, collection) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd2 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd2.line,
        uri = _getDefinitionLineAnd2.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineFeaturesHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _features_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    collection.push(hookDefinition);
  };
}

function defineStep(cwd, collection) {
  return function (pattern, options, code) {
    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd3 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd3.line,
        uri = _getDefinitionLineAnd3.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, pattern: pattern, options: options },
      fnName: 'defineStep',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var stepDefinition = new _step_definition2.default({
      code: code,
      line: line,
      options: options,
      pattern: pattern,
      uri: uri
    });
    collection.push(stepDefinition);
  };
}

function getDefinitionLineAndUri(cwd) {
  var stackframes = _stacktraceJs2.default.getSync();
  var stackframe = _lodash2.default.find(stackframes, function (frame, index) {
    var filename = frame.getFileName();
    var result = !_lodash2.default.includes(filename, _path2.default.join(__dirname, '..', '..', 'src')) && !_lodash2.default.includes(filename, _path2.default.join(__dirname, '..', '..', 'lib')) && !_lodash2.default.startsWith(filename, '../') && filename != '(native)';
    console.log('checking index', index, 'with filename', frame.getFileName(), 'when made relative', 'has result', result);
    return result;
  });
  var line = stackframe.getLineNumber();
  var uri = stackframe.getFileName();
  if (uri) {
    uri = _path2.default.relative(cwd, uri.replace(/\//g, _path2.default.sep));
  } else {
    uri = 'unknown';
  }
  return { line: line, uri: uri };
}

function registerHandler(cwd, collection) {
  return function (eventName, options, code) {
    var _$assign;

    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd4 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd4.line,
        uri = _getDefinitionLineAnd4.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, eventName: eventName, options: options },
      fnName: 'registerHandler',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var listener = _lodash2.default.assign((_$assign = {}, (0, _defineProperty3.default)(_$assign, 'handle' + eventName, code), (0, _defineProperty3.default)(_$assign, 'location', (0, _helpers.formatLocation)({ line: line, uri: uri })), _$assign), options);
    collection.push(listener);
  };
}

function addTransform(parameterTypeRegistry) {
  return _util2.default.deprecate(function (_ref) {
    var captureGroupRegexps = _ref.captureGroupRegexps,
        transformer = _ref.transformer,
        typeName = _ref.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, captureGroupRegexps, transformer);
    parameterTypeRegistry.defineParameterType(parameter);
  }, 'addTransform is deprecated and will be removed in a future version. Please use defineParameterType instead.');
}

function defineParameterType(parameterTypeRegistry) {
  return function (_ref2) {
    var regexp = _ref2.regexp,
        transformer = _ref2.transformer,
        typeName = _ref2.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, regexp, transformer);
    parameterTypeRegistry.defineParameterType(parameter);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdXBwb3J0X2NvZGVfbGlicmFyeS9tZXRob2RfaGVscGVycy5qcyJdLCJuYW1lcyI6WyJkZWZpbmVTY2VuYXJpb0hvb2siLCJkZWZpbmVGZWF0dXJlc0hvb2siLCJkZWZpbmVTdGVwIiwicmVnaXN0ZXJIYW5kbGVyIiwiYWRkVHJhbnNmb3JtIiwiZGVmaW5lUGFyYW1ldGVyVHlwZSIsImN3ZCIsImNvbGxlY3Rpb24iLCJvcHRpb25zIiwiY29kZSIsInRhZ3MiLCJnZXREZWZpbml0aW9uTGluZUFuZFVyaSIsImxpbmUiLCJ1cmkiLCJhcmdzIiwiZm5OYW1lIiwibG9jYXRpb24iLCJob29rRGVmaW5pdGlvbiIsInB1c2giLCJwYXR0ZXJuIiwic3RlcERlZmluaXRpb24iLCJzdGFja2ZyYW1lcyIsImdldFN5bmMiLCJzdGFja2ZyYW1lIiwiZmluZCIsImZyYW1lIiwiaW5kZXgiLCJmaWxlbmFtZSIsImdldEZpbGVOYW1lIiwicmVzdWx0IiwiaW5jbHVkZXMiLCJqb2luIiwiX19kaXJuYW1lIiwic3RhcnRzV2l0aCIsImNvbnNvbGUiLCJsb2ciLCJnZXRMaW5lTnVtYmVyIiwicmVsYXRpdmUiLCJyZXBsYWNlIiwic2VwIiwiZXZlbnROYW1lIiwibGlzdGVuZXIiLCJhc3NpZ24iLCJwYXJhbWV0ZXJUeXBlUmVnaXN0cnkiLCJkZXByZWNhdGUiLCJjYXB0dXJlR3JvdXBSZWdleHBzIiwidHJhbnNmb3JtZXIiLCJ0eXBlTmFtZSIsInBhcmFtZXRlciIsInJlZ2V4cCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztRQVdnQkEsa0IsR0FBQUEsa0I7UUF3QkFDLGtCLEdBQUFBLGtCO1FBd0JBQyxVLEdBQUFBLFU7UUFxREFDLGUsR0FBQUEsZTtRQXVCQUMsWSxHQUFBQSxZO1FBWUFDLG1CLEdBQUFBLG1COztBQW5KaEI7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FB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QkFBN0IsRUFBb0Q7QUFDekQsU0FBTyxpQkFBdUM7QUFBQSxRQUFwQ00sTUFBb0MsU0FBcENBLE1BQW9DO0FBQUEsUUFBNUJILFdBQTRCLFNBQTVCQSxXQUE0QjtBQUFBLFFBQWZDLFFBQWUsU0FBZkEsUUFBZTs7QUFDNUMsUUFBTUMsWUFBWSx1Q0FBa0JELFFBQWxCLEVBQTRCLElBQTVCLEVBQWtDRSxNQUFsQyxFQUEwQ0gsV0FBMUMsQ0FBbEI7QUFDQUgsMEJBQXNCdEMsbUJBQXRCLENBQTBDMkMsU0FBMUM7QUFDRCxHQUhEO0FBSUQiLCJmaWxlIjoibWV0aG9kX2hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCBmcm9tICd1dGlsJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IHsgUGFyYW1ldGVyVHlwZSB9IGZyb20gJ2N1Y3VtYmVyLWV4cHJlc3Npb25zJ1xuaW1wb3J0IHsgZm9ybWF0TG9jYXRpb24gfSBmcm9tICcuLi9mb3JtYXR0ZXIvaGVscGVycydcbmltcG9ydCBTY2VuYXJpb0hvb2tEZWZpbml0aW9uIGZyb20gJy4uL21vZGVscy9zY2VuYXJpb19ob29rX2RlZmluaXRpb24nXG5pbXBvcnQgRmVhdHVyZXNIb29rRGVmaW5pdGlvbiBmcm9tICcuLi9tb2RlbHMvZmVhdHVyZXNfaG9va19kZWZpbml0aW9uJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBTdGFja1RyYWNlIGZyb20gJ3N0YWNrdHJhY2UtanMnXG5pbXBvcnQgU3RlcERlZmluaXRpb24gZnJvbSAnLi4vbW9kZWxzL3N0ZXBfZGVmaW5pdGlvbidcbmltcG9ydCB2YWxpZGF0ZUFyZ3VtZW50cyBmcm9tICcuL3ZhbGlkYXRlX2FyZ3VtZW50cydcblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVNjZW5hcmlvSG9vayhjd2QsIGNvbGxlY3Rpb24pIHtcbiAgcmV0dXJuIChvcHRpb25zLCBjb2RlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgb3B0aW9ucyA9IHsgdGFnczogb3B0aW9ucyB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29kZSA9IG9wdGlvbnNcbiAgICAgIG9wdGlvbnMgPSB7fVxuICAgIH1cbiAgICBjb25zdCB7IGxpbmUsIHVyaSB9ID0gZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkoY3dkKVxuICAgIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICAgIGFyZ3M6IHsgY29kZSwgb3B0aW9ucyB9LFxuICAgICAgZm5OYW1lOiAnZGVmaW5lU2NlbmFyaW9Ib29rJyxcbiAgICAgIGxvY2F0aW9uOiBmb3JtYXRMb2NhdGlvbih7IGxpbmUsIHVyaSB9KVxuICAgIH0pXG4gICAgY29uc3QgaG9va0RlZmluaXRpb24gPSBuZXcgU2NlbmFyaW9Ib29rRGVmaW5pdGlvbih7XG4gICAgICBjb2RlLFxuICAgICAgbGluZSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICB1cmlcbiAgICB9KVxuICAgIGNvbGxlY3Rpb24ucHVzaChob29rRGVmaW5pdGlvbilcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRmVhdHVyZXNIb29rKGN3ZCwgY29sbGVjdGlvbikge1xuICByZXR1cm4gKG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zID0geyB0YWdzOiBvcHRpb25zIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb2RlID0gb3B0aW9uc1xuICAgICAgb3B0aW9ucyA9IHt9XG4gICAgfVxuICAgIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpXG4gICAgdmFsaWRhdGVBcmd1bWVudHMoe1xuICAgICAgYXJnczogeyBjb2RlLCBvcHRpb25zIH0sXG4gICAgICBmbk5hbWU6ICdkZWZpbmVGZWF0dXJlc0hvb2snLFxuICAgICAgbG9jYXRpb246IGZvcm1hdExvY2F0aW9uKHsgbGluZSwgdXJpIH0pXG4gICAgfSlcbiAgICBjb25zdCBob29rRGVmaW5pdGlvbiA9IG5ldyBGZWF0dXJlc0hvb2tEZWZpbml0aW9uKHtcbiAgICAgIGNvZGUsXG4gICAgICBsaW5lLFxuICAgICAgb3B0aW9ucyxcbiAgICAgIHVyaVxuICAgIH0pXG4gICAgY29sbGVjdGlvbi5wdXNoKGhvb2tEZWZpbml0aW9uKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVTdGVwKGN3ZCwgY29sbGVjdGlvbikge1xuICByZXR1cm4gKHBhdHRlcm4sIG9wdGlvbnMsIGNvZGUpID0+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvZGUgPSBvcHRpb25zXG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG4gICAgY29uc3QgeyBsaW5lLCB1cmkgfSA9IGdldERlZmluaXRpb25MaW5lQW5kVXJpKGN3ZClcbiAgICB2YWxpZGF0ZUFyZ3VtZW50cyh7XG4gICAgICBhcmdzOiB7IGNvZGUsIHBhdHRlcm4sIG9wdGlvbnMgfSxcbiAgICAgIGZuTmFtZTogJ2RlZmluZVN0ZXAnLFxuICAgICAgbG9jYXRpb246IGZvcm1hdExvY2F0aW9uKHsgbGluZSwgdXJpIH0pXG4gICAgfSlcbiAgICBjb25zdCBzdGVwRGVmaW5pdGlvbiA9IG5ldyBTdGVwRGVmaW5pdGlvbih7XG4gICAgICBjb2RlLFxuICAgICAgbGluZSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICBwYXR0ZXJuLFxuICAgICAgdXJpXG4gICAgfSlcbiAgICBjb2xsZWN0aW9uLnB1c2goc3RlcERlZmluaXRpb24pXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkoY3dkKSB7XG4gIGNvbnN0IHN0YWNrZnJhbWVzID0gU3RhY2tUcmFjZS5nZXRTeW5jKClcbiAgY29uc3Qgc3RhY2tmcmFtZSA9IF8uZmluZChzdGFja2ZyYW1lcywgKGZyYW1lLCBpbmRleCkgPT4ge1xuICAgIGNvbnN0IGZpbGVuYW1lID0gZnJhbWUuZ2V0RmlsZU5hbWUoKVxuICAgIGNvbnN0IHJlc3VsdCA9XG4gICAgICAhXy5pbmNsdWRlcyhmaWxlbmFtZSwgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3NyYycpKSAmJlxuICAgICAgIV8uaW5jbHVkZXMoZmlsZW5hbWUsIHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICdsaWInKSkgJiZcbiAgICAgICFfLnN0YXJ0c1dpdGgoZmlsZW5hbWUsICcuLi8nKSAmJlxuICAgICAgZmlsZW5hbWUgIT0gJyhuYXRpdmUpJ1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJ2NoZWNraW5nIGluZGV4JyxcbiAgICAgIGluZGV4LFxuICAgICAgJ3dpdGggZmlsZW5hbWUnLFxuICAgICAgZnJhbWUuZ2V0RmlsZU5hbWUoKSxcbiAgICAgICd3aGVuIG1hZGUgcmVsYXRpdmUnLFxuICAgICAgJ2hhcyByZXN1bHQnLFxuICAgICAgcmVzdWx0XG4gICAgKVxuICAgIHJldHVybiByZXN1bHRcbiAgfSlcbiAgY29uc3QgbGluZSA9IHN0YWNrZnJhbWUuZ2V0TGluZU51bWJlcigpXG4gIGxldCB1cmkgPSBzdGFja2ZyYW1lLmdldEZpbGVOYW1lKClcbiAgaWYgKHVyaSkge1xuICAgIHVyaSA9IHBhdGgucmVsYXRpdmUoY3dkLCB1cmkucmVwbGFjZSgvXFwvL2csIHBhdGguc2VwKSlcbiAgfSBlbHNlIHtcbiAgICB1cmkgPSAndW5rbm93bidcbiAgfVxuICByZXR1cm4geyBsaW5lLCB1cmkgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJIYW5kbGVyKGN3ZCwgY29sbGVjdGlvbikge1xuICByZXR1cm4gKGV2ZW50TmFtZSwgb3B0aW9ucywgY29kZSkgPT4ge1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29kZSA9IG9wdGlvbnNcbiAgICAgIG9wdGlvbnMgPSB7fVxuICAgIH1cbiAgICBjb25zdCB7IGxpbmUsIHVyaSB9ID0gZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkoY3dkKVxuICAgIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICAgIGFyZ3M6IHsgY29kZSwgZXZlbnROYW1lLCBvcHRpb25zIH0sXG4gICAgICBmbk5hbWU6ICdyZWdpc3RlckhhbmRsZXInLFxuICAgICAgbG9jYXRpb246IGZvcm1hdExvY2F0aW9uKHsgbGluZSwgdXJpIH0pXG4gICAgfSlcbiAgICBjb25zdCBsaXN0ZW5lciA9IF8uYXNzaWduKFxuICAgICAge1xuICAgICAgICBbYGhhbmRsZSR7ZXZlbnROYW1lfWBdOiBjb2RlLFxuICAgICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICAgIH0sXG4gICAgICBvcHRpb25zXG4gICAgKVxuICAgIGNvbGxlY3Rpb24ucHVzaChsaXN0ZW5lcilcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkVHJhbnNmb3JtKHBhcmFtZXRlclR5cGVSZWdpc3RyeSkge1xuICByZXR1cm4gdXRpbC5kZXByZWNhdGUoKHsgY2FwdHVyZUdyb3VwUmVnZXhwcywgdHJhbnNmb3JtZXIsIHR5cGVOYW1lIH0pID0+IHtcbiAgICBjb25zdCBwYXJhbWV0ZXIgPSBuZXcgUGFyYW1ldGVyVHlwZShcbiAgICAgIHR5cGVOYW1lLFxuICAgICAgbnVsbCxcbiAgICAgIGNhcHR1cmVHcm91cFJlZ2V4cHMsXG4gICAgICB0cmFuc2Zvcm1lclxuICAgIClcbiAgICBwYXJhbWV0ZXJUeXBlUmVnaXN0cnkuZGVmaW5lUGFyYW1ldGVyVHlwZShwYXJhbWV0ZXIpXG4gIH0sICdhZGRUcmFuc2Zvcm0gaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24uIFBsZWFzZSB1c2UgZGVmaW5lUGFyYW1ldGVyVHlwZSBpbnN0ZWFkLicpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVQYXJhbWV0ZXJUeXBlKHBhcmFtZXRlclR5cGVSZWdpc3RyeSkge1xuICByZXR1cm4gKHsgcmVnZXhwLCB0cmFuc2Zvcm1lciwgdHlwZU5hbWUgfSkgPT4ge1xuICAgIGNvbnN0IHBhcmFtZXRlciA9IG5ldyBQYXJhbWV0ZXJUeXBlKHR5cGVOYW1lLCBudWxsLCByZWdleHAsIHRyYW5zZm9ybWVyKVxuICAgIHBhcmFtZXRlclR5cGVSZWdpc3RyeS5kZWZpbmVQYXJhbWV0ZXJUeXBlKHBhcmFtZXRlcilcbiAgfVxufVxuIl19