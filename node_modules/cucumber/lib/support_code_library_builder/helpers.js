'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

exports.defineScenarioHook = defineScenarioHook;
exports.defineFeaturesHook = defineFeaturesHook;
exports.defineStep = defineStep;
exports.registerHandler = registerHandler;
exports.addTransform = addTransform;
exports.defineParameterType = defineParameterType;

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _cucumberExpressions = require('cucumber-expressions');

var _helpers = require('../formatter/helpers');

var _scenario_hook_definition = require('../models/scenario_hook_definition');

var _scenario_hook_definition2 = _interopRequireDefault(_scenario_hook_definition);

var _features_hook_definition = require('../models/features_hook_definition');

var _features_hook_definition2 = _interopRequireDefault(_features_hook_definition);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _stacktraceJs = require('stacktrace-js');

var _stacktraceJs2 = _interopRequireDefault(_stacktraceJs);

var _step_definition = require('../models/step_definition');

var _step_definition2 = _interopRequireDefault(_step_definition);

var _validate_arguments = require('./validate_arguments');

var _validate_arguments2 = _interopRequireDefault(_validate_arguments);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function defineScenarioHook(cwd, collection) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd.line,
        uri = _getDefinitionLineAnd.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineScenarioHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _scenario_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    collection.push(hookDefinition);
  };
}

function defineFeaturesHook(cwd, collection) {
  return function (options, code) {
    if (typeof options === 'string') {
      options = { tags: options };
    } else if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd2 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd2.line,
        uri = _getDefinitionLineAnd2.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, options: options },
      fnName: 'defineFeaturesHook',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var hookDefinition = new _features_hook_definition2.default({
      code: code,
      line: line,
      options: options,
      uri: uri
    });
    collection.push(hookDefinition);
  };
}

function defineStep(cwd, collection) {
  return function (pattern, options, code) {
    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd3 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd3.line,
        uri = _getDefinitionLineAnd3.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, pattern: pattern, options: options },
      fnName: 'defineStep',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var stepDefinition = new _step_definition2.default({
      code: code,
      line: line,
      options: options,
      pattern: pattern,
      uri: uri
    });
    collection.push(stepDefinition);
  };
}

function getDefinitionLineAndUri(cwd) {
  var stackframes = _stacktraceJs2.default.getSync();
  var stackframe = stackframes.length > 2 ? stackframes[2] : stackframes[0];
  var line = stackframe.getLineNumber();
  var uri = stackframe.getFileName();
  if (uri) {
    uri = _path2.default.relative(cwd, uri.replace(/\//g, _path2.default.sep));
  } else {
    uri = 'unknown';
  }
  return { line: line, uri: uri };
}

function registerHandler(cwd, collection) {
  return function (eventName, options, code) {
    var _$assign;

    if (typeof options === 'function') {
      code = options;
      options = {};
    }

    var _getDefinitionLineAnd4 = getDefinitionLineAndUri(cwd),
        line = _getDefinitionLineAnd4.line,
        uri = _getDefinitionLineAnd4.uri;

    (0, _validate_arguments2.default)({
      args: { code: code, eventName: eventName, options: options },
      fnName: 'registerHandler',
      location: (0, _helpers.formatLocation)({ line: line, uri: uri })
    });
    var listener = _lodash2.default.assign((_$assign = {}, (0, _defineProperty3.default)(_$assign, 'handle' + eventName, code), (0, _defineProperty3.default)(_$assign, 'location', (0, _helpers.formatLocation)({ line: line, uri: uri })), _$assign), options);
    collection.push(listener);
  };
}

function addTransform(parameterTypeRegistry) {
  return _util2.default.deprecate(function (_ref) {
    var captureGroupRegexps = _ref.captureGroupRegexps,
        transformer = _ref.transformer,
        typeName = _ref.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, captureGroupRegexps, transformer);
    parameterTypeRegistry.defineParameterType(parameter);
  }, 'addTransform is deprecated and will be removed in a future version. Please use defineParameterType instead.');
}

function defineParameterType(parameterTypeRegistry) {
  return function (_ref2) {
    var regexp = _ref2.regexp,
        transformer = _ref2.transformer,
        typeName = _ref2.typeName;

    var parameter = new _cucumberExpressions.ParameterType(typeName, null, regexp, transformer);
    parameterTypeRegistry.defineParameterType(parameter);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdXBwb3J0X2NvZGVfbGlicmFyeV9idWlsZGVyL2hlbHBlcnMuanMiXSwibmFtZXMiOlsiZGVmaW5lU2NlbmFyaW9Ib29rIiwiZGVmaW5lRmVhdHVyZXNIb29rIiwiZGVmaW5lU3RlcCIsInJlZ2lzdGVySGFuZGxlciIsImFkZFRyYW5zZm9ybSIsImRlZmluZVBhcmFtZXRlclR5cGUiLCJjd2QiLCJjb2xsZWN0aW9uIiwib3B0aW9ucyIsImNvZGUiLCJ0YWdzIiwiZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkiLCJsaW5lIiwidXJpIiwiYXJncyIsImZuTmFtZSIsImxvY2F0aW9uIiwiaG9va0RlZmluaXRpb24iLCJwdXNoIiwicGF0dGVybiIsInN0ZXBEZWZpbml0aW9uIiwic3RhY2tmcmFtZXMiLCJnZXRTeW5jIiwic3RhY2tmcmFtZSIsImxlbmd0aCIsImdldExpbmVOdW1iZXIiLCJnZXRGaWxlTmFtZSIsInJlbGF0aXZlIiwicmVwbGFjZSIsInNlcCIsImV2ZW50TmFtZSIsImxpc3RlbmVyIiwiYXNzaWduIiwicGFyYW1ldGVyVHlwZVJlZ2lzdHJ5IiwiZGVwcmVjYXRlIiwiY2FwdHVyZUdyb3VwUmVnZXhwcyIsInRyYW5zZm9ybWVyIiwidHlwZU5hbWUiLCJwYXJhbWV0ZXIiLCJyZWdleHAiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7UUFXZ0JBLGtCLEdBQUFBLGtCO1FBd0JBQyxrQixHQUFBQSxrQjtRQXdCQUMsVSxHQUFBQSxVO1FBb0NBQyxlLEdBQUFBLGU7UUF1QkFDLFksR0FBQUEsWTtRQVlBQyxtQixHQUFBQSxtQjs7QUFsSWhCOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVPLFNBQVNMLGtCQUFULENBQTRCTSxHQUE1QixFQUFpQ0MsVUFBakMsRUFBNkM7QUFDbEQsU0FBTyxVQUFDQyxPQUFELEVBQVVDLElBQVYsRUFBbUI7QUFDeEIs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RCxHQW5CRDtBQW9CRDs7QUFFTSxTQUFTM0IsWUFBVCxDQUFzQjZCLHFCQUF0QixFQUE2QztBQUNsRCxTQUFPLGVBQUtDLFNBQUwsQ0FBZSxnQkFBb0Q7QUFBQSxRQUFqREMsbUJBQWlELFFBQWpEQSxtQkFBaUQ7QUFBQSxRQUE1QkMsV0FBNEIsUUFBNUJBLFdBQTRCO0FBQUEsUUFBZkMsUUFBZSxRQUFmQSxRQUFlOztBQUN4RSxRQUFNQyxZQUFZLHVDQUNoQkQsUUFEZ0IsRUFFaEIsSUFGZ0IsRUFHaEJGLG1CQUhnQixFQUloQkMsV0FKZ0IsQ0FBbEI7QUFNQUgsMEJBQXNCNUIsbUJBQXRCLENBQTBDaUMsU0FBMUM7QUFDRCxHQVJNLEVBUUosNkdBUkksQ0FBUDtBQVNEOztBQUVNLFNBQVNqQyxtQkFBVCxDQUE2QjRCLHFCQUE3QixFQUFvRDtBQUN6RCxTQUFPLGlCQUF1QztBQUFBLFFBQXBDTSxNQUFvQyxTQUFwQ0EsTUFBb0M7QUFBQSxRQUE1QkgsV0FBNEIsU0FBNUJBLFdBQTRCO0FBQUEsUUFBZkMsUUFBZSxTQUFmQSxRQUFlOztBQUM1QyxRQUFNQyxZQUFZLHVDQUFrQkQsUUFBbEIsRUFBNEIsSUFBNUIsRUFBa0NFLE1BQWxDLEVBQTBDSCxXQUExQyxDQUFsQjtBQUNBSCwwQkFBc0I1QixtQkFBdEIsQ0FBMENpQyxTQUExQztBQUNELEdBSEQ7QUFJRCIsImZpbGUiOiJoZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV0aWwgZnJvbSAndXRpbCdcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCB7IFBhcmFtZXRlclR5cGUgfSBmcm9tICdjdWN1bWJlci1leHByZXNzaW9ucydcbmltcG9ydCB7IGZvcm1hdExvY2F0aW9uIH0gZnJvbSAnLi4vZm9ybWF0dGVyL2hlbHBlcnMnXG5pbXBvcnQgU2NlbmFyaW9Ib29rRGVmaW5pdGlvbiBmcm9tICcuLi9tb2RlbHMvc2NlbmFyaW9faG9va19kZWZpbml0aW9uJ1xuaW1wb3J0IEZlYXR1cmVzSG9va0RlZmluaXRpb24gZnJvbSAnLi4vbW9kZWxzL2ZlYXR1cmVzX2hvb2tfZGVmaW5pdGlvbidcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgU3RhY2tUcmFjZSBmcm9tICdzdGFja3RyYWNlLWpzJ1xuaW1wb3J0IFN0ZXBEZWZpbml0aW9uIGZyb20gJy4uL21vZGVscy9zdGVwX2RlZmluaXRpb24nXG5pbXBvcnQgdmFsaWRhdGVBcmd1bWVudHMgZnJvbSAnLi92YWxpZGF0ZV9hcmd1bWVudHMnXG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVTY2VuYXJpb0hvb2soY3dkLCBjb2xsZWN0aW9uKSB7XG4gIHJldHVybiAob3B0aW9ucywgY29kZSkgPT4ge1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMgPSB7IHRhZ3M6IG9wdGlvbnMgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvZGUgPSBvcHRpb25zXG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG4gICAgY29uc3QgeyBsaW5lLCB1cmkgfSA9IGdldERlZmluaXRpb25MaW5lQW5kVXJpKGN3ZClcbiAgICB2YWxpZGF0ZUFyZ3VtZW50cyh7XG4gICAgICBhcmdzOiB7IGNvZGUsIG9wdGlvbnMgfSxcbiAgICAgIGZuTmFtZTogJ2RlZmluZVNjZW5hcmlvSG9vaycsXG4gICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICB9KVxuICAgIGNvbnN0IGhvb2tEZWZpbml0aW9uID0gbmV3IFNjZW5hcmlvSG9va0RlZmluaXRpb24oe1xuICAgICAgY29kZSxcbiAgICAgIGxpbmUsXG4gICAgICBvcHRpb25zLFxuICAgICAgdXJpXG4gICAgfSlcbiAgICBjb2xsZWN0aW9uLnB1c2goaG9va0RlZmluaXRpb24pXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZlYXR1cmVzSG9vayhjd2QsIGNvbGxlY3Rpb24pIHtcbiAgcmV0dXJuIChvcHRpb25zLCBjb2RlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgb3B0aW9ucyA9IHsgdGFnczogb3B0aW9ucyB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29kZSA9IG9wdGlvbnNcbiAgICAgIG9wdGlvbnMgPSB7fVxuICAgIH1cbiAgICBjb25zdCB7IGxpbmUsIHVyaSB9ID0gZ2V0RGVmaW5pdGlvbkxpbmVBbmRVcmkoY3dkKVxuICAgIHZhbGlkYXRlQXJndW1lbnRzKHtcbiAgICAgIGFyZ3M6IHsgY29kZSwgb3B0aW9ucyB9LFxuICAgICAgZm5OYW1lOiAnZGVmaW5lRmVhdHVyZXNIb29rJyxcbiAgICAgIGxvY2F0aW9uOiBmb3JtYXRMb2NhdGlvbih7IGxpbmUsIHVyaSB9KVxuICAgIH0pXG4gICAgY29uc3QgaG9va0RlZmluaXRpb24gPSBuZXcgRmVhdHVyZXNIb29rRGVmaW5pdGlvbih7XG4gICAgICBjb2RlLFxuICAgICAgbGluZSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICB1cmlcbiAgICB9KVxuICAgIGNvbGxlY3Rpb24ucHVzaChob29rRGVmaW5pdGlvbilcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lU3RlcChjd2QsIGNvbGxlY3Rpb24pIHtcbiAgcmV0dXJuIChwYXR0ZXJuLCBvcHRpb25zLCBjb2RlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb2RlID0gb3B0aW9uc1xuICAgICAgb3B0aW9ucyA9IHt9XG4gICAgfVxuICAgIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpXG4gICAgdmFsaWRhdGVBcmd1bWVudHMoe1xuICAgICAgYXJnczogeyBjb2RlLCBwYXR0ZXJuLCBvcHRpb25zIH0sXG4gICAgICBmbk5hbWU6ICdkZWZpbmVTdGVwJyxcbiAgICAgIGxvY2F0aW9uOiBmb3JtYXRMb2NhdGlvbih7IGxpbmUsIHVyaSB9KVxuICAgIH0pXG4gICAgY29uc3Qgc3RlcERlZmluaXRpb24gPSBuZXcgU3RlcERlZmluaXRpb24oe1xuICAgICAgY29kZSxcbiAgICAgIGxpbmUsXG4gICAgICBvcHRpb25zLFxuICAgICAgcGF0dGVybixcbiAgICAgIHVyaVxuICAgIH0pXG4gICAgY29sbGVjdGlvbi5wdXNoKHN0ZXBEZWZpbml0aW9uKVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldERlZmluaXRpb25MaW5lQW5kVXJpKGN3ZCkge1xuICBjb25zdCBzdGFja2ZyYW1lcyA9IFN0YWNrVHJhY2UuZ2V0U3luYygpXG4gIGNvbnN0IHN0YWNrZnJhbWUgPSBzdGFja2ZyYW1lcy5sZW5ndGggPiAyID8gc3RhY2tmcmFtZXNbMl0gOiBzdGFja2ZyYW1lc1swXVxuICBjb25zdCBsaW5lID0gc3RhY2tmcmFtZS5nZXRMaW5lTnVtYmVyKClcbiAgbGV0IHVyaSA9IHN0YWNrZnJhbWUuZ2V0RmlsZU5hbWUoKVxuICBpZiAodXJpKSB7XG4gICAgdXJpID0gcGF0aC5yZWxhdGl2ZShjd2QsIHVyaS5yZXBsYWNlKC9cXC8vZywgcGF0aC5zZXApKVxuICB9IGVsc2Uge1xuICAgIHVyaSA9ICd1bmtub3duJ1xuICB9XG4gIHJldHVybiB7IGxpbmUsIHVyaSB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoY3dkLCBjb2xsZWN0aW9uKSB7XG4gIHJldHVybiAoZXZlbnROYW1lLCBvcHRpb25zLCBjb2RlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb2RlID0gb3B0aW9uc1xuICAgICAgb3B0aW9ucyA9IHt9XG4gICAgfVxuICAgIGNvbnN0IHsgbGluZSwgdXJpIH0gPSBnZXREZWZpbml0aW9uTGluZUFuZFVyaShjd2QpXG4gICAgdmFsaWRhdGVBcmd1bWVudHMoe1xuICAgICAgYXJnczogeyBjb2RlLCBldmVudE5hbWUsIG9wdGlvbnMgfSxcbiAgICAgIGZuTmFtZTogJ3JlZ2lzdGVySGFuZGxlcicsXG4gICAgICBsb2NhdGlvbjogZm9ybWF0TG9jYXRpb24oeyBsaW5lLCB1cmkgfSlcbiAgICB9KVxuICAgIGNvbnN0IGxpc3RlbmVyID0gXy5hc3NpZ24oXG4gICAgICB7XG4gICAgICAgIFtgaGFuZGxlJHtldmVudE5hbWV9YF06IGNvZGUsXG4gICAgICAgIGxvY2F0aW9uOiBmb3JtYXRMb2NhdGlvbih7IGxpbmUsIHVyaSB9KVxuICAgICAgfSxcbiAgICAgIG9wdGlvbnNcbiAgICApXG4gICAgY29sbGVjdGlvbi5wdXNoKGxpc3RlbmVyKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRUcmFuc2Zvcm0ocGFyYW1ldGVyVHlwZVJlZ2lzdHJ5KSB7XG4gIHJldHVybiB1dGlsLmRlcHJlY2F0ZSgoeyBjYXB0dXJlR3JvdXBSZWdleHBzLCB0cmFuc2Zvcm1lciwgdHlwZU5hbWUgfSkgPT4ge1xuICAgIGNvbnN0IHBhcmFtZXRlciA9IG5ldyBQYXJhbWV0ZXJUeXBlKFxuICAgICAgdHlwZU5hbWUsXG4gICAgICBudWxsLFxuICAgICAgY2FwdHVyZUdyb3VwUmVnZXhwcyxcbiAgICAgIHRyYW5zZm9ybWVyXG4gICAgKVxuICAgIHBhcmFtZXRlclR5cGVSZWdpc3RyeS5kZWZpbmVQYXJhbWV0ZXJUeXBlKHBhcmFtZXRlcilcbiAgfSwgJ2FkZFRyYW5zZm9ybSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlIHVzZSBkZWZpbmVQYXJhbWV0ZXJUeXBlIGluc3RlYWQuJylcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZVBhcmFtZXRlclR5cGUocGFyYW1ldGVyVHlwZVJlZ2lzdHJ5KSB7XG4gIHJldHVybiAoeyByZWdleHAsIHRyYW5zZm9ybWVyLCB0eXBlTmFtZSB9KSA9PiB7XG4gICAgY29uc3QgcGFyYW1ldGVyID0gbmV3IFBhcmFtZXRlclR5cGUodHlwZU5hbWUsIG51bGwsIHJlZ2V4cCwgdHJhbnNmb3JtZXIpXG4gICAgcGFyYW1ldGVyVHlwZVJlZ2lzdHJ5LmRlZmluZVBhcmFtZXRlclR5cGUocGFyYW1ldGVyKVxuICB9XG59XG4iXX0=