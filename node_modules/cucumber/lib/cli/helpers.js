'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTestCases = exports.getTestCasesFromFilesystem = exports.getExpandedArgv = undefined;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var getExpandedArgv = exports.getExpandedArgv = function () {
  var _ref2 = (0, _bluebird.coroutine)(function* (_ref) {
    var argv = _ref.argv,
        cwd = _ref.cwd;

    var _ArgvParser$parse = _argv_parser2.default.parse(argv),
        options = _ArgvParser$parse.options;

    var fullArgv = argv;
    var profileArgv = yield new _profile_loader2.default(cwd).getArgv(options.profile);
    if (profileArgv.length > 0) {
      fullArgv = _lodash2.default.concat(argv.slice(0, 2), profileArgv, argv.slice(2));
    }
    return fullArgv;
  });

  return function getExpandedArgv(_x) {
    return _ref2.apply(this, arguments);
  };
}();

var getTestCasesFromFilesystem = exports.getTestCasesFromFilesystem = function () {
  var _ref4 = (0, _bluebird.coroutine)(function* (_ref3) {
    var cwd = _ref3.cwd,
        eventBroadcaster = _ref3.eventBroadcaster,
        featurePaths = _ref3.featurePaths,
        pickleFilter = _ref3.pickleFilter;

    var result = [];
    yield _bluebird2.default.each(featurePaths, function () {
      var _ref5 = (0, _bluebird.coroutine)(function* (featurePath) {
        var source = yield _fs2.default.readFile(featurePath, 'utf8');
        result = result.concat((yield getTestCases({
          eventBroadcaster: eventBroadcaster,
          source: source,
          pickleFilter: pickleFilter,
          uri: _path2.default.relative(cwd, featurePath)
        })));
      });

      return function (_x3) {
        return _ref5.apply(this, arguments);
      };
    }());
    return result;
  });

  return function getTestCasesFromFilesystem(_x2) {
    return _ref4.apply(this, arguments);
  };
}();

var getTestCases = exports.getTestCases = function () {
  var _ref7 = (0, _bluebird.coroutine)(function* (_ref6) {
    var eventBroadcaster = _ref6.eventBroadcaster,
        pickleFilter = _ref6.pickleFilter,
        source = _ref6.source,
        uri = _ref6.uri;

    var result = [];
    var events = _gherkin2.default.generateEvents(source, uri);
    events.forEach(function (event) {
      eventBroadcaster.emit(event.type, _lodash2.default.omit(event, 'type'));
      if (event.type === 'pickle') {
        var pickle = event.pickle;

        if (pickleFilter.matches({ pickle: pickle, uri: uri })) {
          eventBroadcaster.emit('pickle-accepted', { pickle: pickle, uri: uri });
          result.push({ pickle: pickle, uri: uri });
        } else {
          eventBroadcaster.emit('pickle-rejected', { pickle: pickle, uri: uri });
        }
      }
      if (event.type === 'attachment') {
        throw new Error(event.data);
      }
    });
    return result;
  });

  return function getTestCases(_x4) {
    return _ref7.apply(this, arguments);
  };
}();

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _argv_parser = require('./argv_parser');

var _argv_parser2 = _interopRequireDefault(_argv_parser);

var _fs = require('mz/fs');

var _fs2 = _interopRequireDefault(_fs);

var _gherkin = require('gherkin');

var _gherkin2 = _interopRequireDefault(_gherkin);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _profile_loader = require('./profile_loader');

var _profile_loader2 = _interopRequireDefault(_profile_loader);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvaGVscGVycy5qcyJdLCJuYW1lcyI6WyJhcmd2IiwiY3dkIiwicGFyc2UiLCJvcHRpb25zIiwiZnVsbEFyZ3YiLCJwcm9maWxlQXJndiIsImdldEFyZ3YiLCJwcm9maWxlIiwibGVuZ3RoIiwiY29uY2F0Iiwic2xpY2UiLCJnZXRFeHBhbmRlZEFyZ3YiLCJldmVudEJyb2FkY2FzdGVyIiwiZmVhdHVyZVBhdGhzIiwicGlja2xlRmlsdGVyIiwicmVzdWx0IiwiZWFjaCIsImZlYXR1cmVQYXRoIiwic291cmNlIiwicmVhZEZpbGUiLCJnZXRUZXN0Q2FzZXMiLCJ1cmkiLCJyZWxhdGl2ZSIsImdldFRlc3RDYXNlc0Zyb21GaWxlc3lzdGVtIiwiZXZlbnRzIiwiZ2VuZXJhdGVFdmVudHMiLCJmb3JFYWNoIiwiZW1pdCIsImV2ZW50IiwidHlwZSIsIm9taXQiLCJwaWNrbGUiLCJtYXRjaGVzIiwicHVzaCIsIkVycm9yIiwiZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O3VDQVFPLGlCQUE4QztBQUFBLFFBQWJBLElBQWEsUUFBYkEsSUFBYTtBQUFBLFFBQVBDLEdBQU8sUUFBUEEsR0FBTzs7QUFBQSw0QkFDakMsc0JBQVdDLEtBQVgsQ0FBaUJGLElBQWpCLENBRGlDO0FBQUEsUUFDN0NHLE9BRDZDLHFCQUM3Q0EsT0FENkM7O0FBRW5ELFFBQUlDLFdBQVdKLElBQWY7QUFDQSxRQUFNSyxjQUFjLE1BQU0sNkJBQWtCSixHQUFsQixFQUF1QkssT0FBdkIsQ0FBK0JILFFBQVFJLE9BQXZDLENBQTFCO0FBQ0EsUUFBSUYsWUFBWUcsTUFBWixHQUFxQixDQUF6QixFQUE0QjtBQUMxQkosaUJBQVcsaUJBQUVLLE1BQUYsQ0FBU1QsS0FBS1UsS0FBTCxDQUFXLENBQVgsRUFBYyxDQUFkLENBQVQsRUFBMkJMLFdBQTNCLEVBQXdDTCxLQUFLVSxLQUFMLENBQVcsQ0FBWCxDQUF4QyxDQUFYO0FBQ0Q7QUFDRCxXQUFPTixRQUFQO0FBQ0QsRzs7a0JBUnFCTyxlOzs7Ozs7dUNBVWYsa0JBS0o7QUFBQSxRQUpEVixHQUlDLFNBSkRBLEdBSUM7QUFBQSxRQUhEVyxnQkFHQyxTQUhEQSxnQkFHQztBQUFBLFFBRkRDLFlBRUMsU0FGREEsWUFFQztBQUFBLFFBRERDLFlBQ0MsU0FEREEsWUFDQzs7QUFDRCxRQUFJQyxTQUFTLEVBQWI7QUFDQSxVQUFNLG1CQUFRQyxJQUFSLENBQWFILFlBQWI7QUFBQSwyQ0FBMkIsV0FBTUksV0FBTixFQUFxQjtBQUNwRCxZQUFNQyxTQUFTLE1BQU0sYUFBR0MsUUFBSCxDQUFZRixXQUFaLEVBQXlCLE1BQXpCLENBQXJCO0FBQ0FGLGlCQUFTQSxPQUFPTixNQUFQLEVBQ1AsTUFBTVcsYUFBYTtBQUNqQlIsNENBRGlCO0FBRWpCTSx3QkFGaUI7QUFHakJKLG9DQUhpQjtBQUlqQk8sZUFBSyxlQUFLQyxRQUFMLENBQWNyQixHQUFkLEVBQW1CZ0IsV0FBbkI7QUFKWSxTQUFiLENBREMsRUFBVDtBQVFELE9BVks7O0FBQUE7QUFBQTtBQUFBO0FBQUEsUUFBTjtBQVdBLFdBQU9GLE1BQVA7QUFDRCxHOztrQkFuQnFCUSwwQjs7Ozs7O3VDQXFCZixrQkFLSjtBQUFBLFFBSkRYLGdCQUlDLFNBSkRBLGdCQUlDO0FBQUEsUUFIREUsWUFHQyxTQUhEQSxZQUdDO0FBQUEsUUFGREksTUFFQyxTQUZEQSxNQUVDO0FBQUEsUUFEREcsR0FDQyxTQUREQSxHQUNDOztBQUNELFFBQU1OLFNBQVMsRUFBZjtBQUNBLFFBQU1TLFNBQVMsa0JBQVFDLGNBQVIsQ0FBdUJQLE1BQXZCLEVBQStCRyxHQUEvQixDQUFmO0FBQ0FHLFdBQU9FLE9BQVAsQ0FBZSxpQkFBUztBQUN0QmQsdUJBQWlCZSxJQUFqQixDQUFzQkMsTUFBTUMsSUFBNUIsRUFBa0MsaUJBQUVDLElBQUYsQ0FBT0YsS0FBUCxFQUFjLE1BQWQsQ0FBbEM7QUFDQSxVQUFJQSxNQUFNQyxJQUFOLEtBQWUsUUFBbkIsRUFBNkI7QUFBQSxZQUNuQkUsTUFEbUIsR0FDUkgsS0FEUSxDQUNuQkcsTUFEbUI7O0FBRTNCLFlBQUlqQixhQUFha0IsT0FBYixDQUFxQixFQUFFRCxjQUFGLEVBQVVWLFFBQVYsRUFBckIsQ0FBSixFQUEyQztBQUN6Q1QsMkJBQWlCZSxJQUFqQixDQUFzQixpQkFBdEIsRUFBeUMsRUFBRUksY0FBRixFQUFVVixRQUFWLEVBQXpDO0FBQ0FOLGlCQUFPa0IsSUFBUCxDQUFZLEVBQUVGLGNBQUYsRUFBVVYsUUFBVixFQUFaO0FBQ0QsU0FIRCxNQUdPO0FBQ0xULDJCQUFpQmUsSUFBakIsQ0FBc0IsaUJBQXRCLEVBQXlDLEVBQUVJLGNBQUYsRUFBVVYsUUFBVixFQUF6QztBQUNEO0FBQ0Y7QUFDRCxVQUFJTyxNQUFNQyxJQUFOLEtBQWUsWUFBbkIsRUFBaUM7QUFDL0IsY0FBTSxJQUFJSyxLQUFKLENBQVVOLE1BQU1PLElBQWhCLENBQU47QUFDRDtBQUNGLEtBZEQ7QUFlQSxXQUFPcEIsTUFBUDtBQUNELEc7O2tCQXhCcUJLLFk7Ozs7O0FBdkN0Qjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0EiLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCBBcmd2UGFyc2VyIGZyb20gJy4vYXJndl9wYXJzZXInXG5pbXBvcnQgZnMgZnJvbSAnbXovZnMnXG5pbXBvcnQgR2hlcmtpbiBmcm9tICdnaGVya2luJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBQcm9maWxlTG9hZGVyIGZyb20gJy4vcHJvZmlsZV9sb2FkZXInXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEV4cGFuZGVkQXJndih7IGFyZ3YsIGN3ZCB9KSB7XG4gIGxldCB7IG9wdGlvbnMgfSA9IEFyZ3ZQYXJzZXIucGFyc2UoYXJndilcbiAgbGV0IGZ1bGxBcmd2ID0gYXJndlxuICBjb25zdCBwcm9maWxlQXJndiA9IGF3YWl0IG5ldyBQcm9maWxlTG9hZGVyKGN3ZCkuZ2V0QXJndihvcHRpb25zLnByb2ZpbGUpXG4gIGlmIChwcm9maWxlQXJndi5sZW5ndGggPiAwKSB7XG4gICAgZnVsbEFyZ3YgPSBfLmNvbmNhdChhcmd2LnNsaWNlKDAsIDIpLCBwcm9maWxlQXJndiwgYXJndi5zbGljZSgyKSlcbiAgfVxuICByZXR1cm4gZnVsbEFyZ3Zcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFRlc3RDYXNlc0Zyb21GaWxlc3lzdGVtKHtcbiAgY3dkLFxuICBldmVudEJyb2FkY2FzdGVyLFxuICBmZWF0dXJlUGF0aHMsXG4gIHBpY2tsZUZpbHRlclxufSkge1xuICBsZXQgcmVzdWx0ID0gW11cbiAgYXdhaXQgUHJvbWlzZS5lYWNoKGZlYXR1cmVQYXRocywgYXN5bmMgZmVhdHVyZVBhdGggPT4ge1xuICAgIGNvbnN0IHNvdXJjZSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZlYXR1cmVQYXRoLCAndXRmOCcpXG4gICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChcbiAgICAgIGF3YWl0IGdldFRlc3RDYXNlcyh7XG4gICAgICAgIGV2ZW50QnJvYWRjYXN0ZXIsXG4gICAgICAgIHNvdXJjZSxcbiAgICAgICAgcGlja2xlRmlsdGVyLFxuICAgICAgICB1cmk6IHBhdGgucmVsYXRpdmUoY3dkLCBmZWF0dXJlUGF0aClcbiAgICAgIH0pXG4gICAgKVxuICB9KVxuICByZXR1cm4gcmVzdWx0XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRUZXN0Q2FzZXMoe1xuICBldmVudEJyb2FkY2FzdGVyLFxuICBwaWNrbGVGaWx0ZXIsXG4gIHNvdXJjZSxcbiAgdXJpXG59KSB7XG4gIGNvbnN0IHJlc3VsdCA9IFtdXG4gIGNvbnN0IGV2ZW50cyA9IEdoZXJraW4uZ2VuZXJhdGVFdmVudHMoc291cmNlLCB1cmkpXG4gIGV2ZW50cy5mb3JFYWNoKGV2ZW50ID0+IHtcbiAgICBldmVudEJyb2FkY2FzdGVyLmVtaXQoZXZlbnQudHlwZSwgXy5vbWl0KGV2ZW50LCAndHlwZScpKVxuICAgIGlmIChldmVudC50eXBlID09PSAncGlja2xlJykge1xuICAgICAgY29uc3QgeyBwaWNrbGUgfSA9IGV2ZW50XG4gICAgICBpZiAocGlja2xlRmlsdGVyLm1hdGNoZXMoeyBwaWNrbGUsIHVyaSB9KSkge1xuICAgICAgICBldmVudEJyb2FkY2FzdGVyLmVtaXQoJ3BpY2tsZS1hY2NlcHRlZCcsIHsgcGlja2xlLCB1cmkgfSlcbiAgICAgICAgcmVzdWx0LnB1c2goeyBwaWNrbGUsIHVyaSB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXZlbnRCcm9hZGNhc3Rlci5lbWl0KCdwaWNrbGUtcmVqZWN0ZWQnLCB7IHBpY2tsZSwgdXJpIH0pXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChldmVudC50eXBlID09PSAnYXR0YWNobWVudCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihldmVudC5kYXRhKVxuICAgIH1cbiAgfSlcbiAgcmV0dXJuIHJlc3VsdFxufVxuIl19