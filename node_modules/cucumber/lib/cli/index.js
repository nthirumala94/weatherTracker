'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _helpers = require('../formatter/helpers');

var _helpers2 = require('./helpers');

var _install_validator = require('./install_validator');

var _i18n = require('./i18n');

var I18n = _interopRequireWildcard(_i18n);

var _configuration_builder = require('./configuration_builder');

var _configuration_builder2 = _interopRequireDefault(_configuration_builder);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _builder = require('../formatter/builder');

var _builder2 = _interopRequireDefault(_builder);

var _fs = require('mz/fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _pickle_filter = require('../pickle_filter');

var _pickle_filter2 = _interopRequireDefault(_pickle_filter);

var _runtime = require('../runtime');

var _runtime2 = _interopRequireDefault(_runtime);

var _support_code_library_builder = require('../support_code_library_builder');

var _support_code_library_builder2 = _interopRequireDefault(_support_code_library_builder);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Cli = function () {
  function Cli(_ref) {
    var argv = _ref.argv,
        cwd = _ref.cwd,
        stdout = _ref.stdout;
    (0, _classCallCheck3.default)(this, Cli);

    this.argv = argv;
    this.cwd = cwd;
    this.stdout = stdout;
  }

  (0, _createClass3.default)(Cli, [{
    key: 'getConfiguration',
    value: function () {
      var _ref2 = (0, _bluebird.coroutine)(function* () {
        var fullArgv = yield (0, _helpers2.getExpandedArgv)({ argv: this.argv, cwd: this.cwd });
        return yield _configuration_builder2.default.build({ argv: fullArgv, cwd: this.cwd });
      });

      function getConfiguration() {
        return _ref2.apply(this, arguments);
      }

      return getConfiguration;
    }()
  }, {
    key: 'initializeFormatters',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* (_ref3) {
        var _this = this;

        var eventBroadcaster = _ref3.eventBroadcaster,
            formatOptions = _ref3.formatOptions,
            formats = _ref3.formats,
            supportCodeLibrary = _ref3.supportCodeLibrary;

        var streamsToClose = [];
        var eventDataCollector = new _helpers.EventDataCollector(eventBroadcaster);
        yield _bluebird2.default.map(formats, function () {
          var _ref6 = (0, _bluebird.coroutine)(function* (_ref5) {
            var _context;

            var type = _ref5.type,
                outputTo = _ref5.outputTo;

            var stream = _this.stdout;
            if (outputTo) {
              var fd = yield _fs2.default.open(_path2.default.resolve(_this.cwd, outputTo), 'w');
              stream = _fs2.default.createWriteStream(null, { fd: fd });
              streamsToClose.push(stream);
            }
            var typeOptions = (0, _extends3.default)({
              eventBroadcaster: eventBroadcaster,
              eventDataCollector: eventDataCollector,
              log: (_context = stream).write.bind(_context),
              stream: stream,
              supportCodeLibrary: supportCodeLibrary
            }, formatOptions);
            return _builder2.default.build(type, typeOptions);
          });

          return function (_x2) {
            return _ref6.apply(this, arguments);
          };
        }());
        return function () {
          return _bluebird2.default.each(streamsToClose, function (stream) {
            return _bluebird2.default.promisify(stream.end.bind(stream))();
          });
        };
      });

      function initializeFormatters(_x) {
        return _ref4.apply(this, arguments);
      }

      return initializeFormatters;
    }()
  }, {
    key: 'getSupportCodeLibrary',
    value: function getSupportCodeLibrary(supportCodePaths) {
      _support_code_library_builder2.default.reset(this.cwd);
      supportCodePaths.forEach(function (codePath) {
        return require(codePath);
      });
      return _support_code_library_builder2.default.finalize();
    }
  }, {
    key: 'run',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* () {
        yield (0, _install_validator.validateInstall)(this.cwd);
        var configuration = yield this.getConfiguration();
        if (configuration.listI18nLanguages) {
          this.stdout.write(I18n.getLanguages());
          return true;
        }
        if (configuration.listI18nKeywordsFor) {
          this.stdout.write(I18n.getKeywords(configuration.listI18nKeywordsFor));
          return true;
        }
        var supportCodeLibrary = this.getSupportCodeLibrary(configuration.supportCodePaths);
        var eventBroadcaster = new _events2.default();
        var cleanup = yield this.initializeFormatters({
          eventBroadcaster: eventBroadcaster,
          formatOptions: configuration.formatOptions,
          formats: configuration.formats,
          supportCodeLibrary: supportCodeLibrary
        });
        var testCases = yield (0, _helpers2.getTestCasesFromFilesystem)({
          cwd: this.cwd,
          eventBroadcaster: eventBroadcaster,
          featurePaths: configuration.featurePaths,
          pickleFilter: new _pickle_filter2.default(configuration.pickleFilterOptions)
        });
        var runtime = new _runtime2.default({
          eventBroadcaster: eventBroadcaster,
          options: configuration.runtimeOptions,
          supportCodeLibrary: supportCodeLibrary,
          testCases: testCases
        });
        var result = yield runtime.start();
        yield cleanup();
        return result;
      });

      function run() {
        return _ref7.apply(this, arguments);
      }

      return run;
    }()
  }]);
  return Cli;
}();

exports.default = Cli;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvaW5kZXguanMiXSwibmFtZXMiOlsiSTE4biIsIkNsaSIsImFyZ3YiLCJjd2QiLCJzdGRvdXQiLCJmdWxsQXJndiIsImJ1aWxkIiwiZXZlbnRCcm9hZGNhc3RlciIsImZvcm1hdE9wdGlvbnMiLCJmb3JtYXRzIiwic3VwcG9ydENvZGVMaWJyYXJ5Iiwic3RyZWFtc1RvQ2xvc2UiLCJldmVudERhdGFDb2xsZWN0b3IiLCJtYXAiLCJ0eXBlIiwib3V0cHV0VG8iLCJzdHJlYW0iLCJmZCIsIm9wZW4iLCJyZXNvbHZlIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJwdXNoIiwidHlwZU9wdGlvbnMiLCJsb2ciLCJ3cml0ZSIsImVhY2giLCJwcm9taXNpZnkiLCJlbmQiLCJzdXBwb3J0Q29kZVBhdGhzIiwicmVzZXQiLCJmb3JFYWNoIiwicmVxdWlyZSIsImNvZGVQYXRoIiwiZmluYWxpemUiLCJjb25maWd1cmF0aW9uIiwiZ2V0Q29uZmlndXJhdGlvbiIsImxpc3RJMThuTGFuZ3VhZ2VzIiwiZ2V0TGFuZ3VhZ2VzIiwibGlzdEkxOG5LZXl3b3Jkc0ZvciIsImdldEtleXdvcmRzIiwiZ2V0U3VwcG9ydENvZGVMaWJyYXJ5IiwiY2xlYW51cCIsImluaXRpYWxpemVGb3JtYXR0ZXJzIiwidGVzdENhc2VzIiwiZmVhdHVyZVBhdGhzIiwicGlja2xlRmlsdGVyIiwicGlja2xlRmlsdGVyT3B0aW9ucyIsInJ1bnRpbWUiLCJvcHRpb25zIiwicnVudGltZU9wdGlvbnMiLCJyZXN1bHQiLCJzdGFydCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztJQUFZQSxJOztBQUNaOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7Ozs7O0lBRXFCQyxHO0FBQ25CLHFCQUFtQztBQUFBLFFBQXJCQyxJQUFxQixRQUFyQkEsSUFBcUI7QUFBQSxRQUFm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ckIsbUJBQW1CLHNCQUF6QjtBQUNBLFlBQU1rQyxVQUFVLE1BQU0sS0FBS0Msb0JBQUwsQ0FBMEI7QUFDOUNuQyw0Q0FEOEM7QUFFOUNDLHlCQUFlMEIsY0FBYzFCLGFBRmlCO0FBRzlDQyxtQkFBU3lCLGNBQWN6QixPQUh1QjtBQUk5Q0M7QUFKOEMsU0FBMUIsQ0FBdEI7QUFNQSxZQUFNaUMsWUFBWSxNQUFNLDBDQUEyQjtBQUNqRHhDLGVBQUssS0FBS0EsR0FEdUM7QUFFakRJLDRDQUZpRDtBQUdqRHFDLHdCQUFjVixjQUFjVSxZQUhxQjtBQUlqREMsd0JBQWMsNEJBQWlCWCxjQUFjWSxtQkFBL0I7QUFKbUMsU0FBM0IsQ0FBeEI7QUFNQSxZQUFNQyxVQUFVLHNCQUFZO0FBQzFCeEMsNENBRDBCO0FBRTFCeUMsbUJBQVNkLGNBQWNlLGNBRkc7QUFHMUJ2QyxnREFIMEI7QUFJMUJpQztBQUowQixTQUFaLENBQWhCO0FBTUEsWUFBTU8sU0FBUyxNQUFNSCxRQUFRSSxLQUFSLEVBQXJCO0FBQ0EsY0FBTVYsU0FBTjtBQUNBLGVBQU9TLE1BQVA7QUFDRCxPOzs7Ozs7Ozs7Ozs7a0JBdEZrQmpELEciLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudERhdGFDb2xsZWN0b3IgfSBmcm9tICcuLi9mb3JtYXR0ZXIvaGVscGVycydcbmltcG9ydCB7IGdldEV4cGFuZGVkQXJndiwgZ2V0VGVzdENhc2VzRnJvbUZpbGVzeXN0ZW0gfSBmcm9tICcuL2hlbHBlcnMnXG5pbXBvcnQgeyB2YWxpZGF0ZUluc3RhbGwgfSBmcm9tICcuL2luc3RhbGxfdmFsaWRhdG9yJ1xuaW1wb3J0ICogYXMgSTE4biBmcm9tICcuL2kxOG4nXG5pbXBvcnQgQ29uZmlndXJhdGlvbkJ1aWxkZXIgZnJvbSAnLi9jb25maWd1cmF0aW9uX2J1aWxkZXInXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cydcbmltcG9ydCBGb3JtYXR0ZXJCdWlsZGVyIGZyb20gJy4uL2Zvcm1hdHRlci9idWlsZGVyJ1xuaW1wb3J0IGZzIGZyb20gJ216L2ZzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBQaWNrbGVGaWx0ZXIgZnJvbSAnLi4vcGlja2xlX2ZpbHRlcidcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IFJ1bnRpbWUgZnJvbSAnLi4vcnVudGltZSdcbmltcG9ydCBzdXBwb3J0Q29kZUxpYnJhcnlCdWlsZGVyIGZyb20gJy4uL3N1cHBvcnRfY29kZV9saWJyYXJ5X2J1aWxkZXInXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaSB7XG4gIGNvbnN0cnVjdG9yKHsgYXJndiwgY3dkLCBzdGRvdXQgfSkge1xuICAgIHRoaXMuYXJndiA9IGFyZ3ZcbiAgICB0aGlzLmN3ZCA9IGN3ZFxuICAgIHRoaXMuc3Rkb3V0ID0gc3Rkb3V0XG4gIH1cblxuICBhc3luYyBnZXRDb25maWd1cmF0aW9uKCkge1xuICAgIGNvbnN0IGZ1bGxBcmd2ID0gYXdhaXQgZ2V0RXhwYW5kZWRBcmd2KHsgYXJndjogdGhpcy5hcmd2LCBjd2Q6IHRoaXMuY3dkIH0pXG4gICAgcmV0dXJuIGF3YWl0IENvbmZpZ3VyYXRpb25CdWlsZGVyLmJ1aWxkKHsgYXJndjogZnVsbEFyZ3YsIGN3ZDogdGhpcy5jd2QgfSlcbiAgfVxuXG4gIGFzeW5jIGluaXRpYWxpemVGb3JtYXR0ZXJzKHtcbiAgICBldmVudEJyb2FkY2FzdGVyLFxuICAgIGZvcm1hdE9wdGlvbnMsXG4gICAgZm9ybWF0cyxcbiAgICBzdXBwb3J0Q29kZUxpYnJhcnlcbiAgfSkge1xuICAgIGNvbnN0IHN0cmVhbXNUb0Nsb3NlID0gW11cbiAgICBjb25zdCBldmVudERhdGFDb2xsZWN0b3IgPSBuZXcgRXZlbnREYXRhQ29sbGVjdG9yKGV2ZW50QnJvYWRjYXN0ZXIpXG4gICAgYXdhaXQgUHJvbWlzZS5tYXAoZm9ybWF0cywgYXN5bmMgKHsgdHlwZSwgb3V0cHV0VG8gfSkgPT4ge1xuICAgICAgbGV0IHN0cmVhbSA9IHRoaXMuc3Rkb3V0XG4gICAgICBpZiAob3V0cHV0VG8pIHtcbiAgICAgICAgbGV0IGZkID0gYXdhaXQgZnMub3BlbihwYXRoLnJlc29sdmUodGhpcy5jd2QsIG91dHB1dFRvKSwgJ3cnKVxuICAgICAgICBzdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShudWxsLCB7IGZkIH0pXG4gICAgICAgIHN0cmVhbXNUb0Nsb3NlLnB1c2goc3RyZWFtKVxuICAgICAgfVxuICAgICAgY29uc3QgdHlwZU9wdGlvbnMgPSB7XG4gICAgICAgIGV2ZW50QnJvYWRjYXN0ZXIsXG4gICAgICAgIGV2ZW50RGF0YUNvbGxlY3RvcixcbiAgICAgICAgbG9nOiA6OnN0cmVhbS53cml0ZSxcbiAgICAgICAgc3RyZWFtLFxuICAgICAgICBzdXBwb3J0Q29kZUxpYnJhcnksXG4gICAgICAgIC4uLmZvcm1hdE9wdGlvbnNcbiAgICAgIH1cbiAgICAgIHJldHVybiBGb3JtYXR0ZXJCdWlsZGVyLmJ1aWxkKHR5cGUsIHR5cGVPcHRpb25zKVxuICAgIH0pXG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIFByb21pc2UuZWFjaChzdHJlYW1zVG9DbG9zZSwgc3RyZWFtID0+XG4gICAgICAgIFByb21pc2UucHJvbWlzaWZ5KDo6c3RyZWFtLmVuZCkoKVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGdldFN1cHBvcnRDb2RlTGlicmFyeShzdXBwb3J0Q29kZVBhdGhzKSB7XG4gICAgc3VwcG9ydENvZGVMaWJyYXJ5QnVpbGRlci5yZXNldCh0aGlzLmN3ZClcbiAgICBzdXBwb3J0Q29kZVBhdGhzLmZvckVhY2goY29kZVBhdGggPT4gcmVxdWlyZShjb2RlUGF0aCkpXG4gICAgcmV0dXJuIHN1cHBvcnRDb2RlTGlicmFyeUJ1aWxkZXIuZmluYWxpemUoKVxuICB9XG5cbiAgYXN5bmMgcnVuKCkge1xuICAgIGF3YWl0IHZhbGlkYXRlSW5zdGFsbCh0aGlzLmN3ZClcbiAgICBjb25zdCBjb25maWd1cmF0aW9uID0gYXdhaXQgdGhpcy5nZXRDb25maWd1cmF0aW9uKClcbiAgICBpZiAoY29uZmlndXJhdGlvbi5saXN0STE4bkxhbmd1YWdlcykge1xuICAgICAgdGhpcy5zdGRvdXQud3JpdGUoSTE4bi5nZXRMYW5ndWFnZXMoKSlcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGlmIChjb25maWd1cmF0aW9uLmxpc3RJMThuS2V5d29yZHNGb3IpIHtcbiAgICAgIHRoaXMuc3Rkb3V0LndyaXRlKEkxOG4uZ2V0S2V5d29yZHMoY29uZmlndXJhdGlvbi5saXN0STE4bktleXdvcmRzRm9yKSlcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGNvbnN0IHN1cHBvcnRDb2RlTGlicmFyeSA9IHRoaXMuZ2V0U3VwcG9ydENvZGVMaWJyYXJ5KFxuICAgICAgY29uZmlndXJhdGlvbi5zdXBwb3J0Q29kZVBhdGhzXG4gICAgKVxuICAgIGNvbnN0IGV2ZW50QnJvYWRjYXN0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgICBjb25zdCBjbGVhbnVwID0gYXdhaXQgdGhpcy5pbml0aWFsaXplRm9ybWF0dGVycyh7XG4gICAgICBldmVudEJyb2FkY2FzdGVyLFxuICAgICAgZm9ybWF0T3B0aW9uczogY29uZmlndXJhdGlvbi5mb3JtYXRPcHRpb25zLFxuICAgICAgZm9ybWF0czogY29uZmlndXJhdGlvbi5mb3JtYXRzLFxuICAgICAgc3VwcG9ydENvZGVMaWJyYXJ5XG4gICAgfSlcbiAgICBjb25zdCB0ZXN0Q2FzZXMgPSBhd2FpdCBnZXRUZXN0Q2FzZXNGcm9tRmlsZXN5c3RlbSh7XG4gICAgICBjd2Q6IHRoaXMuY3dkLFxuICAgICAgZXZlbnRCcm9hZGNhc3RlcixcbiAgICAgIGZlYXR1cmVQYXRoczogY29uZmlndXJhdGlvbi5mZWF0dXJlUGF0aHMsXG4gICAgICBwaWNrbGVGaWx0ZXI6IG5ldyBQaWNrbGVGaWx0ZXIoY29uZmlndXJhdGlvbi5waWNrbGVGaWx0ZXJPcHRpb25zKVxuICAgIH0pXG4gICAgY29uc3QgcnVudGltZSA9IG5ldyBSdW50aW1lKHtcbiAgICAgIGV2ZW50QnJvYWRjYXN0ZXIsXG4gICAgICBvcHRpb25zOiBjb25maWd1cmF0aW9uLnJ1bnRpbWVPcHRpb25zLFxuICAgICAgc3VwcG9ydENvZGVMaWJyYXJ5LFxuICAgICAgdGVzdENhc2VzXG4gICAgfSlcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBydW50aW1lLnN0YXJ0KClcbiAgICBhd2FpdCBjbGVhbnVwKClcbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cbn1cbiJdfQ==